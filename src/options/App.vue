<template>
  <div>
    <header class="p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800">
        TagDown Setting
      </h1>
    </header>
    <main class="container p-4 mx-auto">
      <section class="p-8 border-b-2 border-gray-200">
        <h2 class="text-2xl font-bold py-4 text-gray-800">
          IndexedDB 数据库
        </h2>
        <div class="flex items-start flex-wrap space-x-8">
          <div class="space-y-4">
            <h3 class="text-base font-bold">
              手动备份
            </h3>
            <div
              class="p-4 flex flex-col items-center space-y-4 border-2 border-gray-200 border-dashed rounded"
            >
              <button
                title="export indexedDB database"
                class="px-2 py-1 flex items-center text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
                @click="exportDatabase"
              >
                <svg
                  class="w-6 h-6"
                  viewBox="0 0 50 50"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M16.3349 15.0472C16.1999 14.9131 16.0927 14.7538 16.0197 14.5786C15.9466 14.4033 15.909 14.2155 15.909 14.0258C15.9091 13.8361 15.9467 13.6482 16.0199 13.473C16.093 13.2978 16.2002 13.1385 16.3353 13.0044L23.9716 5.42291C24.2444 5.15212 24.6143 5 25 5C25.3857 5 25.7556 5.15212 26.0284 5.42291L33.6647 13.0044C33.8023 13.138 33.9118 13.2973 33.9869 13.4732C34.0621 13.6491 34.1013 13.838 34.1024 14.0291C34.1035 14.2201 34.0664 14.4095 33.9933 14.5862C33.9202 14.7629 33.8125 14.9234 33.6765 15.0585C33.5405 15.1936 33.3788 15.3006 33.2009 15.3732C33.0229 15.4459 32.8322 15.4827 32.6399 15.4817C32.4475 15.4806 32.2572 15.4417 32.0801 15.3671C31.903 15.2925 31.7425 15.1838 31.608 15.0472L26.4545 9.93102V26.6667C26.4545 27.0498 26.3013 27.4172 26.0285 27.6881C25.7557 27.959 25.3858 28.1111 25 28.1111C24.6142 28.1111 24.2443 27.959 23.9715 27.6881C23.6987 27.4172 23.5455 27.0498 23.5455 26.6667V9.93102L18.392 15.0472C18.2569 15.1814 18.0966 15.2878 17.9201 15.3604C17.7436 15.433 17.5545 15.4704 17.3635 15.4704C17.1724 15.4704 16.9833 15.433 16.8068 15.3604C16.6303 15.2878 16.47 15.1814 16.3349 15.0472ZM38.0909 19.4445H33.7273C33.3415 19.4445 32.9715 19.5967 32.6988 19.8675C32.426 20.1384 32.2727 20.5058 32.2727 20.8889C32.2727 21.272 32.426 21.6394 32.6988 21.9103C32.9715 22.1812 33.3415 22.3334 33.7273 22.3334H38.0909V41.1111H11.9091V22.3334H16.2727C16.6585 22.3334 17.0285 22.1812 17.3012 21.9103C17.574 21.6394 17.7273 21.272 17.7273 20.8889C17.7273 20.5058 17.574 20.1384 17.3012 19.8675C17.0285 19.5967 16.6585 19.4445 16.2727 19.4445H11.9091C11.1378 19.4453 10.3984 19.75 9.85301 20.2916C9.30764 20.8331 9.00087 21.5674 9 22.3334V41.1111C9.00087 41.877 9.30764 42.6113 9.85301 43.1529C10.3984 43.6945 11.1378 43.9991 11.9091 44H38.0909C38.8622 43.9991 39.6016 43.6945 40.147 43.1529C40.6924 42.6113 40.9991 41.877 41 41.1111V22.3334C40.9991 21.5674 40.6924 20.8331 40.147 20.2916C39.6016 19.75 38.8622 19.4453 38.0909 19.4445Z"
                  />
                </svg>
                <span class="text-base">导出</span>
              </button>
              <input
                id="importDatabase"
                ref="importDatabase"
                type="file"
                name="importDatabase"
                class="hidden"
                accept=".json"
                @change="inputFile"
              >
              <button
                title="import indexedDB database"
                class="px-2 py-1 flex items-center text-base text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
                @click="importDatabaseHandler"
              >
                <svg
                  class="w-6 h-6"
                  viewBox="0 0 50 50"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M33.2496 28.4169C33.5622 28.7295 33.7378 29.1534 33.7378 29.5955C33.7378 30.0376 33.5622 30.4616 33.2496 30.7742L26.1785 37.8452C26.169 37.8548 26.1587 37.8629 26.149 37.8721C26.1194 37.9002 26.0898 37.9283 26.0583 37.9542C26.0448 37.9652 26.0302 37.975 26.0165 37.9854C25.9871 38.0081 25.9579 38.031 25.9269 38.0517C25.9156 38.0594 25.9033 38.0656 25.8917 38.0729C25.8573 38.0948 25.8229 38.1165 25.7867 38.1358C25.7783 38.1404 25.769 38.1442 25.7604 38.1485C25.7208 38.169 25.6806 38.1887 25.639 38.2058C25.6333 38.2083 25.6273 38.21 25.6215 38.2121C25.577 38.2303 25.5317 38.2466 25.4858 38.2608C25.4798 38.2629 25.4735 38.2637 25.4677 38.2656C25.4217 38.2793 25.3751 38.291 25.3281 38.3006C25.3146 38.3033 25.3006 38.3046 25.2871 38.3069C25.2473 38.314 25.2073 38.3208 25.1663 38.3248C25.0556 38.336 24.9442 38.336 24.8335 38.3248C24.7925 38.3206 24.7525 38.3137 24.7127 38.3069C24.6992 38.3044 24.6854 38.3033 24.6721 38.3006C24.6249 38.291 24.5782 38.2793 24.5321 38.2656C24.5262 38.2637 24.5202 38.2627 24.5142 38.2608C24.4683 38.2467 24.4232 38.2305 24.3787 38.2123L24.361 38.206C24.3198 38.1885 24.2793 38.1693 24.2396 38.1485C24.231 38.1442 24.2219 38.1404 24.2133 38.136C24.1776 38.1163 24.1426 38.0952 24.1083 38.0729C24.0967 38.0656 24.0844 38.0594 24.0729 38.0517C24.0421 38.0308 24.0129 38.0081 23.9835 37.9854C23.9698 37.975 23.9552 37.9652 23.9419 37.9542C23.9106 37.9279 23.8803 37.9005 23.851 37.8721C23.8412 37.8629 23.831 37.8548 23.8215 37.8452L16.7504 30.7742C16.4378 30.4616 16.2621 30.0376 16.2621 29.5956C16.2621 29.1535 16.4376 28.7295 16.7502 28.4169C17.0628 28.1043 17.4867 27.9286 17.9288 27.9286C18.3709 27.9285 18.7949 28.1041 19.1075 28.4167L23.3333 32.6431V20C23.3333 19.558 23.5089 19.134 23.8215 18.8215C24.134 18.5089 24.558 18.3333 25 18.3333C25.442 18.3333 25.866 18.5089 26.1785 18.8215C26.4911 19.134 26.6667 19.558 26.6667 20V32.6431L30.8925 28.4169C31.2051 28.1044 31.629 27.9289 32.071 27.9289C32.513 27.9289 32.937 28.1044 33.2496 28.4169V28.4169ZM45 13.3333V41.6667C44.999 42.5504 44.6475 43.3977 44.0226 44.0226C43.3977 44.6475 42.5504 44.999 41.6667 45H8.33333C7.44958 44.999 6.60231 44.6475 5.97741 44.0226C5.3525 43.3977 5.00099 42.5504 5 41.6667V13.3333C5.00019 13.2718 5.00374 13.2103 5.01062 13.1492C5.0125 13.134 5.01562 13.119 5.01771 13.1038C5.02396 13.0577 5.03146 13.0121 5.04167 12.9673C5.04542 12.9502 5.05021 12.9337 5.05458 12.9167C5.07001 12.8566 5.08879 12.7974 5.11083 12.7394C5.12667 12.6983 5.14403 12.658 5.16292 12.6185C5.1675 12.6085 5.17083 12.5977 5.17604 12.5879L8.50938 5.92125C8.6478 5.64443 8.86057 5.41162 9.12384 5.24891C9.38712 5.0862 9.6905 5.00001 10 5H40C40.3095 5.00001 40.6129 5.0862 40.8762 5.24891C41.1394 5.41162 41.3522 5.64443 41.4906 5.92125L44.824 12.5879C44.829 12.5979 44.8323 12.6085 44.8373 12.6185C44.8827 12.7142 44.9189 12.814 44.9454 12.9165C44.9496 12.9335 44.9546 12.9504 44.9583 12.9675C44.9683 13.0121 44.9758 13.0573 44.9823 13.1033C44.9844 13.1185 44.9875 13.134 44.9894 13.1492C44.9963 13.2103 44.9998 13.2718 45 13.3333V13.3333ZM9.36333 11.6667H40.6367L38.97 8.33333H11.03L9.36333 11.6667ZM41.6687 41.6667L41.6667 15H8.33333V41.6667H41.6687Z"
                  />
                </svg>

                <span class="text-base">导入</span>
              </button>
              <button
                title="import indexedDB database"
                class="px-2 py-1 flex items-center text-base text-white bg-red-400 hover:bg-red-600 space-x-1 rounded"
                @click="deleteDatabaseHandler"
              >
                <svg
                  class="w-6 h-6"
                  viewBox="0 0 50 50"
                  fill="currentColor"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M41.5 11H34.0007V9.5C33.9994 8.30694 33.5249 7.16312 32.6813 6.3195C31.8376 5.47588 30.6938 5.00134 29.5007 5H20.5007C19.3077 5.00134 18.1639 5.47588 17.3202 6.3195C16.4766 7.16312 16.0021 8.30694 16.0007 9.5V11H8.5C8.10217 11 7.72064 11.158 7.43934 11.4393C7.15804 11.7206 7 12.1022 7 12.5C7 12.8978 7.15804 13.2794 7.43934 13.5607C7.72064 13.842 8.10217 14 8.5 14H10V41C10.0009 41.7954 10.3173 42.5579 10.8797 43.1203C11.4421 43.6827 12.2046 43.9991 13 44H37C37.7954 43.9991 38.5579 43.6827 39.1203 43.1203C39.6827 42.5579 39.9991 41.7954 40 41V14H41.5C41.8978 14 42.2794 13.842 42.5607 13.5607C42.842 13.2794 43 12.8978 43 12.5C43 12.1022 42.842 11.7206 42.5607 11.4393C42.2794 11.158 41.8978 11 41.5 11ZM19.0007 9.5C19.0012 9.10233 19.1594 8.72109 19.4406 8.43989C19.7218 8.15869 20.1031 8.0005 20.5007 8H29.5007C29.8984 8.0005 30.2797 8.15869 30.5609 8.43989C30.8421 8.72109 31.0003 9.10233 31.0007 9.5V11H19.0007V9.5ZM37 41H13V14H37V41ZM22.0007 21.5V33.5C22.0007 33.8978 21.8427 34.2794 21.5614 34.5607C21.2801 34.842 20.8986 35 20.5007 35C20.1029 35 19.7214 34.842 19.4401 34.5607C19.1588 34.2794 19.0007 33.8978 19.0007 33.5V21.5C19.0007 21.1022 19.1588 20.7206 19.4401 20.4393C19.7214 20.158 20.1029 20 20.5007 20C20.8986 20 21.2801 20.158 21.5614 20.4393C21.8427 20.7206 22.0007 21.1022 22.0007 21.5ZM31.0007 21.5V33.5C31.0007 33.8978 30.8427 34.2794 30.5614 34.5607C30.2801 34.842 29.8986 35 29.5007 35C29.1029 35 28.7214 34.842 28.4401 34.5607C28.1588 34.2794 28.0007 33.8978 28.0007 33.5V21.5C28.0007 21.1022 28.1588 20.7206 28.4401 20.4393C28.7214 20.158 29.1029 20 29.5007 20C29.8986 20 30.2801 20.158 30.5614 20.4393C30.8427 20.7206 31.0007 21.1022 31.0007 21.5Z"
                  />
                </svg>

                <span class="text-base">删除</span>
              </button>
            </div>
          </div>
          <div class="space-y-4">
            <h3 class="text-base font-bold">
              WebDAV 备份
            </h3>
            <div
              class="p-4 flex flex-col items-center border-2 border-gray-200 border-dashed rounded"
            >
              <div
                v-show="showWebDAVInfo"
                class="space-y-2"
              >
                <div class="flex items-center space-x-4">
                  <label
                    class="text-base"
                    for="url"
                  >网址</label>
                  <input
                    id="url"
                    v-model="webDAVUrl"
                    class="input-style p-0.5"
                    type="url"
                    name="url"
                    required
                  >
                </div>
                <div class="flex items-center space-x-4">
                  <label
                    class="text-base"
                    for="username"
                  >账户</label>
                  <input
                    id="username"
                    v-model="webDAVUsername"
                    class="input-style p-0.5"
                    type="text"
                    name="username"
                    required
                  >
                </div>
                <div class="flex items-center space-x-4">
                  <label
                    class="text-base"
                    for="password"
                  >密码</label>
                  <input
                    id="password"
                    v-model="webDAVPassword"
                    class="input-style p-0.5"
                    type="password"
                    name="password"
                    required
                  >
                </div>
                <div class="flex items-center space-x-4">
                  <span class="text-base">同步</span>
                  <div class="px-2 py-1 flex items-center hover:bg-gray-200 rounded space-x-0.5">
                    <input
                      id="manual"
                      v-model="webDAVSync"
                      type="radio"
                      value="manual"
                    >
                    <label for="manual">手动</label>
                  </div>
                  <div class="px-2 py-1 flex items-center hover:bg-gray-200 rounded space-x-0.5">
                    <input
                      id="auto"
                      v-model="webDAVSync"
                      type="radio"
                      value="auto"
                    >
                    <label for="auto">自动</label>
                  </div>
                </div>
                <div class="flex justify-between items-center">
                  <button
                    title="set webdav information"
                    class="px-2 py-1 text-sm text-white bg-green-400 hover:bg-green-600 rounded"
                    :class="{
                      'opacity-10': !webDAVInfoIntegrity
                    }"
                    :disabled="!webDAVInfoIntegrity"
                    @click="saveWebDAVInfoHandler"
                  >
                    确定
                  </button>
                  <button
                    title="cancel setting webdav information"
                    class="px-2 py-1 text-sm text-white bg-gray-400 hover:bg-gray-600 rounded"
                    :class="{
                      'opacity-10': webDAVState === '未添加' || webDAVState === '未获得访问权限' || webDAVState === '连接失败'
                    }"
                    :disabled="webDAVState === '未添加' || webDAVState === '未获得访问权限' || webDAVState === '连接失败'"
                    @click="toggleWebDAVInfoHandler"
                  >
                    取消
                  </button>
                  <button
                    title="cancel setting webdav information"
                    class="px-2 py-1 text-sm text-white bg-red-400 hover:bg-red-600 rounded"
                    @click="clearWebDAVInfoHandler"
                  >
                    清空
                  </button>
                </div>
              </div>
              <div
                v-show="!showWebDAVInfo"
                class="space-y-2"
              >
                <button
                  title="sync indexedDB database"
                  class="px-2 py-1 flex items-center text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
                  @click="createDatabaseBackupHandler"
                >
                  <svg
                    class="w-6 h-6"
                    viewBox="0 0 50 50"
                    fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M44.9999 24.5C45.009 27.6394 44.0045 30.6955 42.1397 33.2016C42.0377 33.3414 41.9094 33.4593 41.7622 33.5486C41.6151 33.6378 41.4519 33.6967 41.2822 33.7217C41.1126 33.7468 40.9397 33.7376 40.7735 33.6946C40.6073 33.6516 40.4512 33.5757 40.3141 33.4712C40.177 33.3668 40.0616 33.2359 39.9746 33.086C39.8877 32.9362 39.8308 32.7703 39.8072 32.5981C39.7837 32.4258 39.794 32.2506 39.8376 32.0824C39.8812 31.9142 39.9571 31.7564 40.0611 31.6182C41.1733 30.1142 41.9172 28.3638 42.2314 26.5112C42.5456 24.6586 42.4212 22.7567 41.8684 20.9624C41.3156 19.1681 40.3502 17.5327 39.0518 16.1909C37.7534 14.8492 36.1592 13.8395 34.4004 13.2451C32.6417 12.6506 30.7689 12.4885 28.9363 12.772C27.1036 13.0555 25.3637 13.7765 23.8598 14.8757C22.3558 15.9748 21.131 17.4206 20.2862 19.0939C19.4415 20.7672 19.0009 22.6201 19.0008 24.5C19.0008 24.8496 18.8639 25.1848 18.6201 25.4321C18.3763 25.6793 18.0457 25.8181 17.7009 25.8181C17.3561 25.8181 17.0255 25.6793 16.7817 25.4321C16.5379 25.1848 16.4009 24.8496 16.4009 24.5C16.4001 23.1696 16.5802 21.8456 16.9362 20.5652C16.758 20.5525 16.5795 20.5459 16.4009 20.5454C14.3323 20.5454 12.3484 21.3787 10.8857 22.8619C9.42295 24.3452 8.60119 26.3569 8.60119 28.4545C8.60119 30.5521 9.42295 32.5639 10.8857 34.0471C12.3484 35.5303 14.3323 36.3636 16.4009 36.3636H20.3008C20.6456 36.3636 20.9762 36.5025 21.22 36.7497C21.4638 36.9969 21.6007 37.3322 21.6007 37.6818C21.6007 38.0314 21.4638 38.3667 21.22 38.6139C20.9762 38.8611 20.6456 39 20.3008 39H16.4009C14.9714 39.0002 13.5571 38.7015 12.2465 38.1226C10.9358 37.5437 9.757 36.6969 8.78355 35.6353C7.8101 34.5737 7.06296 33.32 6.58877 31.9524C6.11458 30.5849 5.92354 29.1329 6.02757 27.6871C6.13161 26.2413 6.52848 24.8328 7.19341 23.5496C7.85834 22.2663 8.77704 21.1358 9.89215 20.2287C11.0073 19.3216 12.2948 18.6574 13.6744 18.2775C15.0541 17.8977 16.4961 17.8103 17.9105 18.0209C19.3498 15.0983 21.7204 12.7542 24.6378 11.3687C27.5553 9.98311 30.8488 9.63728 33.9844 10.3872C37.1199 11.1372 39.9138 12.9389 41.9132 15.5005C43.9126 18.062 45.0003 21.2332 44.9999 24.5ZM30.3202 23.5687C30.2897 23.5376 30.2576 23.5081 30.2242 23.4803C30.2105 23.469 30.1962 23.4593 30.1822 23.4485C30.1623 23.4334 30.1426 23.4177 30.122 23.4036C30.1044 23.3917 30.0864 23.3816 30.0685 23.3706C30.05 23.3594 30.0319 23.3477 30.0128 23.3373C29.9944 23.3274 29.9754 23.3189 29.9565 23.31C29.937 23.3004 29.9175 23.2905 29.8976 23.282C29.8794 23.2745 29.8608 23.2683 29.8423 23.2617C29.8209 23.2536 29.7994 23.2452 29.7773 23.2386C29.7591 23.233 29.7404 23.2289 29.7221 23.2241C29.6993 23.2184 29.677 23.2119 29.6541 23.2073C29.633 23.203 29.6117 23.2007 29.5904 23.1974C29.5698 23.1945 29.5493 23.1905 29.5284 23.1884C29.4907 23.1848 29.4528 23.1828 29.4149 23.1826C29.4101 23.1826 29.4052 23.1818 29.4005 23.1818C29.3958 23.1818 29.3909 23.1826 29.386 23.1826C29.3481 23.1828 29.3103 23.1848 29.2726 23.1884C29.2516 23.1905 29.2313 23.1945 29.2105 23.1974C29.1894 23.2007 29.1679 23.203 29.1468 23.2073C29.1239 23.2119 29.1015 23.2184 29.0791 23.2241C29.0605 23.2289 29.0419 23.233 29.0237 23.2386C29.0016 23.2452 28.9801 23.2536 28.9587 23.2617C28.9401 23.2683 28.9216 23.2745 28.9034 23.2821C28.8833 23.2905 28.8639 23.3004 28.8444 23.31C28.8256 23.3189 28.8066 23.3274 28.7882 23.3373C28.769 23.3477 28.7508 23.3594 28.7325 23.3708C28.7146 23.3816 28.6966 23.3917 28.6792 23.4036C28.6584 23.4177 28.6387 23.4332 28.6187 23.4485C28.6049 23.4593 28.5904 23.469 28.5768 23.4803C28.5433 23.5081 28.5112 23.5376 28.4806 23.5687L22.966 29.1606C22.8441 29.2827 22.7472 29.4281 22.6809 29.5883C22.6146 29.7486 22.5802 29.9205 22.5797 30.0943C22.5792 30.2681 22.6126 30.4403 22.6779 30.6009C22.7433 30.7616 22.8393 30.9075 22.9605 31.0304C23.0817 31.1533 23.2256 31.2506 23.3841 31.3169C23.5425 31.3832 23.7123 31.417 23.8837 31.4164C24.0551 31.4159 24.2246 31.381 24.3827 31.3138C24.5407 31.2465 24.684 31.1483 24.8045 31.0246L28.1005 27.6824V37.6818C28.1005 38.0314 28.2375 38.3667 28.4813 38.6139C28.7251 38.8611 29.0557 39 29.4005 39C29.7452 39 30.0759 38.8611 30.3197 38.6139C30.5635 38.3667 30.7004 38.0314 30.7004 37.6818V27.6824L33.9965 31.0246C34.1169 31.1483 34.2603 31.2465 34.4183 31.3138C34.5763 31.381 34.7459 31.4159 34.9173 31.4164C35.0887 31.417 35.2584 31.3832 35.4169 31.3169C35.5753 31.2506 35.7193 31.1533 35.8404 31.0304C35.9616 30.9075 36.0577 30.7616 36.123 30.6009C36.1884 30.4403 36.2217 30.2681 36.2212 30.0943C36.2207 29.9205 36.1863 29.7486 36.12 29.5883C36.0537 29.4281 35.9568 29.2827 35.8349 29.1606L30.3202 23.5687Z"
                    />
                  </svg>
                  <span class="text-base">创建备份</span>
                </button>
                <button
                  title="sync indexedDB database"
                  class="px-2 py-1 flex items-center text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
                  @click="getDatabaseBackupHandler"
                >
                  <svg
                    class="w-6 h-6"
                    viewBox="0 0 50 50"
                    fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M34.8348 31.1571C34.9555 31.2796 35.0513 31.4249 35.1166 31.5848C35.1819 31.7447 35.2156 31.9162 35.2156 32.0893C35.2156 32.2624 35.1819 32.4338 35.1166 32.5937C35.0513 32.7537 34.9555 32.899 34.8348 33.0214L29.32 38.6133C29.2894 38.6443 29.2573 38.6737 29.2238 38.7014C29.2102 38.713 29.1959 38.7225 29.1819 38.7332C29.1619 38.7486 29.1423 38.7642 29.1216 38.7782C29.1041 38.7901 29.0859 38.8003 29.068 38.8112C29.0496 38.8225 29.0316 38.8342 29.0126 38.8445C28.9939 38.8545 28.9746 38.8632 28.9555 38.8725C28.936 38.8817 28.9172 38.8914 28.8974 38.8997C28.8787 38.9076 28.8597 38.9138 28.8408 38.9207C28.8197 38.9283 28.7989 38.9366 28.7773 38.9432C28.7583 38.9491 28.7389 38.9534 28.7198 38.9581C28.698 38.9638 28.6764 38.97 28.6541 38.9745C28.6314 38.9791 28.6086 38.9817 28.5859 38.985C28.5667 38.9878 28.5478 38.9916 28.5283 38.9934C28.4431 39.0019 28.3572 39.0019 28.2719 38.9934C28.2524 38.9916 28.2336 38.9878 28.2144 38.985C28.1916 38.9817 28.1689 38.9791 28.1461 38.9745C28.1239 38.97 28.1023 38.9638 28.0805 38.9581C28.0613 38.9532 28.0421 38.9491 28.023 38.9433C28.0013 38.9367 27.9807 38.9285 27.9596 38.9207C27.9406 38.9138 27.9216 38.9076 27.9029 38.8997C27.883 38.8914 27.864 38.8815 27.8449 38.8723C27.8257 38.8632 27.8065 38.8545 27.7877 38.8445C27.7688 38.8341 27.7508 38.8225 27.7324 38.8113C27.7145 38.8003 27.6962 38.7901 27.6788 38.7784C27.658 38.7642 27.6383 38.7486 27.6185 38.7332C27.6045 38.7225 27.5901 38.7128 27.5766 38.7014C27.5431 38.6737 27.511 38.6443 27.4804 38.6133L21.9656 33.0214C21.8437 32.8993 21.7468 32.7539 21.6805 32.5936C21.6142 32.4334 21.5798 32.2614 21.5792 32.0877C21.5787 31.9139 21.6121 31.7417 21.6774 31.5811C21.7427 31.4204 21.8388 31.2744 21.9599 31.1516C22.0811 31.0287 22.2251 30.9313 22.3835 30.865C22.5419 30.7988 22.7117 30.7649 22.8831 30.7654C23.0545 30.766 23.2241 30.8008 23.3821 30.8681C23.5402 30.9353 23.6835 31.0335 23.804 31.1571L27.1001 34.4996V24.5C27.1001 24.1504 27.2371 23.8151 27.4809 23.5679C27.7247 23.3207 28.0553 23.1818 28.4001 23.1818C28.7449 23.1818 29.0756 23.3207 29.3194 23.5679C29.5631 23.8151 29.7001 24.1504 29.7001 24.5V34.4996L32.9963 31.1571C33.117 31.0347 33.2603 30.9376 33.418 30.8714C33.5757 30.8051 33.7448 30.771 33.9155 30.771C34.0862 30.771 34.2553 30.8051 34.413 30.8714C34.5707 30.9376 34.7141 31.0347 34.8348 31.1571ZM29.7001 10C27.0442 10.0023 24.4414 10.7537 22.1826 12.1702C19.9238 13.5867 18.0981 15.6124 16.9098 18.0208C15.4954 17.8104 14.0534 17.8979 12.6739 18.2778C11.2943 18.6578 10.0069 19.322 8.89184 20.2291C7.77681 21.1362 6.85819 22.2667 6.19331 23.5499C5.52844 24.8331 5.1316 26.2415 5.02757 27.6871C4.92355 29.1328 5.11456 30.5847 5.5887 31.9522C6.06283 33.3197 6.8099 34.5733 7.78327 35.6349C8.75663 36.6965 9.93537 37.5433 11.2459 38.1222C12.5564 38.7012 13.9706 39 15.4001 39H19.3001C19.6449 39 19.9756 38.8611 20.2194 38.6139C20.4632 38.3667 20.6001 38.0314 20.6001 37.6818C20.6001 37.3322 20.4632 36.9969 20.2194 36.7497C19.9756 36.5025 19.6449 36.3636 19.3001 36.3636H15.4001C13.3315 36.3636 11.3475 35.5304 9.88473 34.0471C8.42195 32.5639 7.60017 30.5522 7.60017 28.4545C7.60017 26.3569 8.42195 24.3452 9.88473 22.862C11.3475 21.3787 13.3315 20.5455 15.4001 20.5455C15.5792 20.5455 15.7576 20.5529 15.9354 20.5652C15.5794 21.8456 15.3993 23.1697 15.4001 24.5C15.4001 24.8496 15.5371 25.1849 15.7809 25.4321C16.0247 25.6793 16.3554 25.8182 16.7001 25.8182C17.0449 25.8182 17.3756 25.6793 17.6194 25.4321C17.8632 25.1849 18.0001 24.8496 18.0001 24.5C18.0003 22.6203 18.441 20.7676 19.2859 19.0944C20.1307 17.4213 21.3556 15.9757 22.8595 14.8767C24.3634 13.7777 26.1033 13.0568 27.9359 12.7733C29.7684 12.4899 31.6412 12.652 33.3998 13.2464C35.1585 13.8408 36.7526 14.8504 38.051 16.1921C39.3494 17.5337 40.3148 19.169 40.8676 20.9631C41.4205 22.7572 41.545 24.6589 41.2309 26.5114C40.9168 28.364 40.1731 30.1143 39.0611 31.6182C38.9571 31.7565 38.8811 31.9142 38.8376 32.0824C38.794 32.2506 38.7837 32.4259 38.8072 32.5981C38.8307 32.7704 38.8876 32.9362 38.9746 33.086C39.0616 33.2359 39.177 33.3668 39.3141 33.4712C39.4512 33.5757 39.6073 33.6516 39.7735 33.6946C39.9397 33.7376 40.1126 33.7468 40.2823 33.7217C40.452 33.6967 40.6151 33.6378 40.7623 33.5486C40.9094 33.4593 41.0377 33.3414 41.1398 33.2016C42.7332 31.0473 43.7036 28.4856 43.9422 25.8036C44.1807 23.1216 43.6781 20.4251 42.4905 18.0165C41.3029 15.6078 39.4772 13.582 37.2182 12.1661C34.9591 10.7503 32.3559 10.0002 29.7001 10Z"
                    />
                  </svg>
                  <span class="text-base">恢复备份</span>
                </button>
              </div>
            </div>
            <div class="flex justify-between items-center">
              <div class="flex items-center space-x-2">
                <div
                  v-if="webDAVState !== '连接成功'"
                  class="text-red-400"
                >
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 50 50"
                    fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M36.97 35.495L36.965 35.4898L19.8372 17.8327L19.8289 17.8239L12.6531 10.4262C12.5364 10.3013 12.3942 10.1994 12.235 10.1266C12.0758 10.0538 11.9027 10.0114 11.7259 10.002C11.549 9.99259 11.3719 10.0163 11.2049 10.0718C11.0379 10.1272 10.8844 10.2133 10.7533 10.325C10.6222 10.4367 10.5162 10.5717 10.4415 10.7222C10.3667 10.8728 10.3247 11.0357 10.3179 11.2017C10.3111 11.3676 10.3396 11.5331 10.4018 11.6885C10.4641 11.844 10.5587 11.9863 10.6803 12.1071L17.2206 18.8499L17.2106 18.8697C15.76 18.6708 14.2813 18.7543 12.8668 19.115C11.4522 19.4756 10.1321 20.1057 8.98894 20.9658C7.84578 21.8259 6.90406 22.8977 6.22258 24.1142C5.5411 25.3306 5.13449 26.6657 5.02812 28.036C4.92175 29.4064 5.11791 30.7825 5.60435 32.0786C6.0908 33.3747 6.85709 34.5629 7.85539 35.5691C8.85368 36.5752 10.0626 37.3777 11.4065 37.9265C12.7505 38.4752 14.2008 38.7584 15.6668 38.7584H30.3334C32.1461 38.7618 33.9436 38.4478 35.6332 37.8324L37.3469 39.5991C37.5856 39.8409 37.9167 39.9846 38.268 39.9988C38.6193 40.0131 38.9623 39.8967 39.2225 39.675C39.4826 39.4533 39.6388 39.1443 39.657 38.8152C39.6753 38.4861 39.5541 38.1636 39.3199 37.9179L36.97 35.495ZM30.3334 36.2591H15.6668C13.545 36.2591 11.5102 35.4692 10.0099 34.0631C8.50964 32.657 7.66679 30.7499 7.66679 28.7614C7.66679 26.7729 8.50964 24.8658 10.0099 23.4597C11.5102 22.0536 13.545 21.2637 15.6668 21.2637C15.8508 21.2637 16.0341 21.2707 16.2169 21.2824C15.8523 22.4963 15.6672 23.7514 15.6668 25.0125C15.6668 25.344 15.8072 25.6618 16.0573 25.8962C16.3073 26.1305 16.6465 26.2622 17.0001 26.2622C17.3537 26.2622 17.6928 26.1305 17.9429 25.8962C18.1929 25.6618 18.3334 25.344 18.3334 25.0125C18.3335 23.5933 18.6198 22.1868 19.1773 20.8672L33.6772 35.8158C32.5906 36.111 31.4647 36.2603 30.3334 36.2591V36.2591ZM45 25.0125C45.0023 28.3897 43.6758 31.6491 41.2743 34.167C41.0387 34.4141 40.708 34.5634 40.355 34.5821C40.0019 34.6007 39.6554 34.4871 39.3917 34.2663C39.128 34.0455 38.9687 33.7355 38.9488 33.4046C38.9289 33.0737 39.0501 32.749 39.2857 32.5018C41.2606 30.4276 42.3459 27.7415 42.3322 24.9615C42.3185 22.1816 41.2068 19.5049 39.2116 17.4479C37.2164 15.3908 34.4791 14.0992 31.5277 13.8221C28.5762 13.5451 25.6199 14.3023 23.2291 15.9476C22.9441 16.1403 22.5894 16.2197 22.2423 16.1686C21.8951 16.1175 21.5836 15.94 21.3753 15.6747C21.167 15.4095 21.0789 15.0779 21.13 14.7521C21.1812 14.4262 21.3676 14.1325 21.6486 13.9348C23.8338 12.4303 26.4213 11.523 29.1235 11.3136C31.8258 11.1042 34.5371 11.6009 36.9564 12.7485C39.3756 13.8962 41.408 15.6499 42.828 17.8148C44.2479 19.9798 44.9998 22.4713 45 25.0125V25.0125Z"
                    />
                  </svg>
                </div>
                <div
                  v-if="webDAVState === '连接成功'"
                  class="text-green-400"
                >
                  <svg
                    class="w-4 h-4"
                    viewBox="0 0 50 50"
                    fill="currentColor"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M30.3329 10C27.609 10.0023 24.9393 10.7794 22.6225 12.2445C20.3056 13.7096 18.4329 15.8048 17.2138 18.296C15.7631 18.0787 14.2843 18.1695 12.8695 18.5628C11.4547 18.956 10.1344 19.6433 8.9909 20.5818C7.84745 21.5202 6.90542 22.6897 6.22363 24.0171C5.54184 25.3445 5.13491 26.8014 5.02826 28.2968C4.92161 29.7922 5.11752 31.2941 5.60377 32.7086C6.09001 34.1232 6.85615 35.42 7.85436 36.5182C8.85256 37.6164 10.0614 38.4924 11.4054 39.0914C12.7494 39.6905 14.1998 39.9998 15.6659 40H30.3329C34.2229 40 37.9535 38.4196 40.7041 35.6066C43.4547 32.7936 45 28.9782 45 25C45 21.0218 43.4547 17.2064 40.7041 14.3934C37.9535 11.5804 34.2229 10 30.3329 10ZM30.3329 37.2727H15.6659C13.5441 37.2727 11.5092 36.4107 10.0089 34.8763C8.50856 33.3419 7.66568 31.2609 7.66568 29.0909C7.66568 26.921 8.50856 24.8399 10.0089 23.3055C11.5092 21.7711 13.5441 20.9091 15.6659 20.9091C15.8495 20.9091 16.0325 20.9154 16.2149 20.928C15.8496 22.253 15.6648 23.6233 15.6659 25C15.6659 25.3617 15.8064 25.7085 16.0564 25.9642C16.3065 26.22 16.6456 26.3636 16.9993 26.3636C17.3529 26.3636 17.692 26.22 17.9421 25.9642C18.1922 25.7085 18.3326 25.3617 18.3326 25C18.3326 22.5727 19.0364 20.1999 20.355 18.1816C21.6737 16.1634 23.5479 14.5904 25.7406 13.6615C27.9334 12.7326 30.3463 12.4895 32.6741 12.9631C35.0019 13.4366 37.1402 14.6055 38.8185 16.3219C40.4967 18.0382 41.6396 20.225 42.1027 22.6057C42.5657 24.9864 42.3281 27.454 41.4198 29.6966C40.5115 31.9391 38.9734 33.8559 37 35.2044C35.0265 36.5529 32.7064 37.2727 30.3329 37.2727ZM36.6093 21.9903C36.7331 22.1169 36.8313 22.2672 36.8983 22.4327C36.9653 22.5981 36.9998 22.7755 36.9998 22.9545C36.9998 23.1336 36.9653 23.311 36.8983 23.4764C36.8313 23.6419 36.7331 23.7922 36.6093 23.9188L28.6091 32.1006C28.4853 32.2273 28.3383 32.3277 28.1765 32.3962C28.0147 32.4648 27.8413 32.5 27.6662 32.5C27.4911 32.5 27.3177 32.4648 27.1559 32.3962C26.9942 32.3277 26.8472 32.2273 26.7234 32.1006L22.7232 28.0097C22.5994 27.8831 22.5012 27.7328 22.4342 27.5673C22.3672 27.4019 22.3327 27.2245 22.3327 27.0455C22.3327 26.8664 22.3672 26.689 22.4342 26.5236C22.5012 26.3582 22.5994 26.2078 22.7232 26.0812C22.9733 25.8255 23.3125 25.6818 23.6661 25.6818C23.8412 25.6818 24.0146 25.7171 24.1764 25.7856C24.3382 25.8541 24.4851 25.9546 24.609 26.0812L27.6662 29.208L34.7236 21.9903C34.8474 21.8637 34.9944 21.7632 35.1561 21.6947C35.3179 21.6261 35.4913 21.5909 35.6664 21.5909C35.8415 21.5909 36.0149 21.6261 36.1767 21.6947C36.3385 21.7632 36.4855 21.8637 36.6093 21.9903Z"
                    />
                  </svg>
                </div>
                <span class="text-gray-400">{{ webDAVState }}</span>
              </div>
              <button
                v-show="!showWebDAVInfo && webDAVState !== '未添加'"
                class="px-1 py-0.5 text-xs text-white bg-green-400 hover:bg-green-600 rounded"
                @click="toggleWebDAVInfoHandler"
              >
                修改
              </button>
            </div>
            <div class="flex items-center text-gray-400 text-xs space-x-4">
              <span>最近备份时间</span>
              <span>{{ webDAVBackupTimeString }}</span>
            </div>
          </div>
        </div>
      </section>
      <section class="p-8 border-b-2 border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold py-4 text-gray-800">
            按标签导出书签
          </h2>
          <div class="flex items-center space-x-2">
            <button
              titile="select all tags"
              class="px-2 py-1 text-sm text-white bg-green-400 hover:bg-green-600 rounded"
              @click="selectTags = new Set(allTags)"
            >
              全选
            </button>
            <button
              title="unselect all tags"
              class="px-2 py-1 text-sm text-white bg-red-400 hover:bg-red-600 rounded"
              @click="selectTags.clear()"
            >
              全不选
            </button>
            <button
              title="export bookmarks order by tags"
              class="px-2 py-1 text-sm text-white bg-green-400 hover:bg-green-600 rounded"
              @click="exportBookmarks('tag')"
            >
              导出书签
            </button>
          </div>
        </div>
        <div class="p-2 flex items-center space-x-1">
          <input
            id="tagShareable"
            v-model="tagShareable"
            type="checkbox"
            name="tagShareable"
          >
          <label
            for="tagShareable"
            class="flex items-center text-green-400"
          >
            <svg
              class="w-5 h-5"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M34.9183 30.7139C33.9734 30.7136 33.0381 30.9046 32.1678 31.2756C31.2974 31.6466 30.5098 32.1901 29.8515 32.8738L21.6901 27.5808C22.331 25.9199 22.331 24.0769 21.6901 22.416L29.8515 17.1232C31.0766 18.3875 32.7235 19.148 34.4728 19.2571C36.2221 19.3662 37.9493 18.8163 39.3196 17.7139C40.6898 16.6114 41.6055 15.0351 41.8892 13.2903C42.1729 11.5455 41.8043 9.75662 40.855 8.27038C39.9056 6.78413 38.4431 5.7064 36.7509 5.24608C35.0586 4.78576 33.2573 4.97564 31.6959 5.77891C30.1346 6.58219 28.9245 7.94165 28.3002 9.59377C27.6759 11.2459 27.6819 13.073 28.317 14.7209L20.1554 20.0139C19.1726 18.9959 17.9111 18.2967 16.5324 18.0057C15.1536 17.7146 13.7201 17.845 12.4151 18.3801C11.1101 18.9153 9.99303 19.8308 9.20656 21.0098C8.42009 22.1887 8 23.5775 8 24.9985C8 26.4196 8.42009 27.8083 9.20656 28.9873C9.99303 30.1662 11.1101 31.0818 12.4151 31.6169C13.7201 32.152 15.1536 32.2824 16.5324 31.9914C17.9111 31.7003 19.1726 31.0011 20.1554 29.9831L28.317 35.2759C27.7706 36.6983 27.6899 38.2598 28.0868 39.7318C28.4837 41.2037 29.3373 42.5089 30.5226 43.4561C31.7079 44.4033 33.1627 44.9428 34.6739 44.9957C36.1852 45.0486 37.6735 44.612 38.921 43.7499C40.1685 42.8877 41.1096 41.6454 41.6066 40.2047C42.1036 38.764 42.1304 37.2006 41.6829 35.7434C41.2355 34.2863 40.3374 33.0119 39.1202 32.1069C37.9029 31.2018 36.4304 30.7137 34.9183 30.7139ZM34.9183 7.85223C35.7587 7.85223 36.5802 8.10363 37.279 8.57465C37.9777 9.04566 38.5224 9.71513 38.844 10.4984C39.1656 11.2817 39.2497 12.1436 39.0858 12.9751C38.9218 13.8066 38.5171 14.5704 37.9229 15.1699C37.3286 15.7693 36.5715 16.1776 35.7472 16.343C34.923 16.5084 34.0686 16.4235 33.2922 16.0991C32.5157 15.7746 31.8521 15.2252 31.3852 14.5203C30.9183 13.8154 30.6691 12.9866 30.6691 12.1388C30.6703 11.0023 31.1184 9.91276 31.915 9.10915C32.7116 8.30554 33.7917 7.85351 34.9183 7.85223ZM15.0888 29.2851C14.2484 29.2851 13.4268 29.0337 12.7281 28.5627C12.0293 28.0916 11.4847 27.4222 11.1631 26.6389C10.8415 25.8556 10.7573 24.9938 10.9213 24.1622C11.0852 23.3307 11.4899 22.5669 12.0842 21.9674C12.6784 21.368 13.4356 20.9597 14.2598 20.7943C15.0841 20.6289 15.9384 20.7138 16.7149 21.0382C17.4913 21.3627 18.1549 21.9121 18.6218 22.617C19.0887 23.3219 19.338 24.1507 19.338 24.9985C19.3367 26.135 18.8886 27.2246 18.092 28.0282C17.2954 28.8318 16.2153 29.2838 15.0888 29.2851ZM34.9183 42.1448C34.0778 42.1448 33.2563 41.8934 32.5575 41.4224C31.8588 40.9514 31.3141 40.2819 30.9925 39.4986C30.6709 38.7153 30.5868 37.8535 30.7507 37.0219C30.9147 36.1904 31.3194 35.4266 31.9136 34.8272C32.5079 34.2277 33.265 33.8194 34.0893 33.654C34.9135 33.4886 35.7679 33.5735 36.5443 33.8979C37.3208 34.2224 37.9844 34.7718 38.4513 35.4767C38.9182 36.1817 39.1674 37.0104 39.1674 37.8582C39.1662 38.9947 38.7181 40.0843 37.9215 40.8879C37.1249 41.6915 36.0448 42.1435 34.9183 42.1448Z"
              />
            </svg>
            <span class="text-sm">仅导出可分享书签</span>
          </label>
        </div>
        <div>
          <div class="flex flex-wrap">
            <button
              v-for="tag of allTags"
              :key="tag"
              title="toggle select tag"
              class="p-1 mt-2 ml-2 flex items-center border-2 border-green-400 space-x-1 rounded"
              :class="{
                'text-green-600 hover:text-white hover:bg-green-400 ': !selectTags.has(tag),
                'text-white bg-green-400 hover:bg-green-600': selectTags.has(tag)
              }"
              @click="toggleTagHandler(tag)"
            >
              <svg
                class="w-5 h-5"
                viewBox="0 0 50 50"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M43.1947 23.754L25.2464 5.80594C24.9268 5.48534 24.5327 5.24888 24.0993 5.11767C23.666 4.98646 23.2069 4.96459 22.7631 5.05401L8.90377 7.82581C8.63772 7.87911 8.39338 8.00993 8.20151 8.2018C8.00964 8.39366 7.87882 8.638 7.82552 8.90405L5.05386 22.7632C4.96461 23.2071 4.98654 23.6661 5.11771 24.0993C5.24888 24.5326 5.48521 24.9267 5.80563 25.2465L23.7537 43.1944C24.009 43.4498 24.3121 43.6524 24.6457 43.7906C24.9793 43.9288 25.3369 44 25.698 44C26.0591 44 26.4166 43.9289 26.7502 43.7907C27.0839 43.6525 27.387 43.45 27.6423 43.1946L43.1945 27.6424C43.4499 27.3871 43.6524 27.084 43.7906 26.7504C43.9288 26.4168 44 26.0593 44 25.6982C44 25.3372 43.9289 24.9796 43.7907 24.646C43.6526 24.3124 43.45 24.0093 43.1947 23.754ZM25.6982 41.2505L7.74974 23.3024L10.3418 10.3423L23.3023 7.75021L41.2506 25.6983L25.6982 41.2505ZM18.4508 16.389C18.4508 16.7968 18.3299 17.1955 18.1033 17.5346C17.8767 17.8737 17.5547 18.1379 17.1779 18.294C16.8011 18.4501 16.3865 18.4909 15.9865 18.4114C15.5865 18.3318 15.2191 18.1354 14.9308 17.847C14.6424 17.5587 14.446 17.1913 14.3664 16.7913C14.2869 16.3913 14.3277 15.9767 14.4838 15.5999C14.6398 15.2231 14.9041 14.9011 15.2432 14.6745C15.5823 14.448 15.981 14.327 16.3888 14.327C16.9355 14.3276 17.4596 14.5451 17.8462 14.9316C18.2328 15.3182 18.4502 15.8423 18.4508 16.389Z"
                />
              </svg>
              <span class="text-sm">{{ tag }}</span>
            </button>
          </div>
        </div>
      </section>
      <section class="p-8 border-b-2 border-gray-200">
        <div class="flex justify-between items-center">
          <h2 class="text-2xl font-bold py-4 text-gray-800">
            按分组导出书签
          </h2>
          <div class="flex items-center space-x-2">
            <button
              titile="select all groups"
              class="px-2 py-1 text-sm text-white bg-green-400 hover:bg-green-600 rounded"
              @click="selectGroups = new Set(allGroups)"
            >
              全选
            </button>
            <button
              title="unselect all groups"
              class="px-2 py-1 text-sm text-white bg-red-400 hover:bg-red-600 rounded"
              @click="selectGroups.clear()"
            >
              全不选
            </button>
            <button
              title="export bookmarks order by groups"
              class="px-2 py-1 text-sm text-white bg-green-400 hover:bg-green-600 rounded"
              @click="exportBookmarks('group')"
            >
              导出书签
            </button>
          </div>
        </div>
        <div class="p-2 flex items-center space-x-1">
          <input
            id="groupShareable"
            v-model="groupShareable"
            type="checkbox"
            name="groupShareable"
          >
          <label
            for="groupShareable"
            class="flex items-center text-green-400"
          >
            <svg
              class="w-5 h-5"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M34.9183 30.7139C33.9734 30.7136 33.0381 30.9046 32.1678 31.2756C31.2974 31.6466 30.5098 32.1901 29.8515 32.8738L21.6901 27.5808C22.331 25.9199 22.331 24.0769 21.6901 22.416L29.8515 17.1232C31.0766 18.3875 32.7235 19.148 34.4728 19.2571C36.2221 19.3662 37.9493 18.8163 39.3196 17.7139C40.6898 16.6114 41.6055 15.0351 41.8892 13.2903C42.1729 11.5455 41.8043 9.75662 40.855 8.27038C39.9056 6.78413 38.4431 5.7064 36.7509 5.24608C35.0586 4.78576 33.2573 4.97564 31.6959 5.77891C30.1346 6.58219 28.9245 7.94165 28.3002 9.59377C27.6759 11.2459 27.6819 13.073 28.317 14.7209L20.1554 20.0139C19.1726 18.9959 17.9111 18.2967 16.5324 18.0057C15.1536 17.7146 13.7201 17.845 12.4151 18.3801C11.1101 18.9153 9.99303 19.8308 9.20656 21.0098C8.42009 22.1887 8 23.5775 8 24.9985C8 26.4196 8.42009 27.8083 9.20656 28.9873C9.99303 30.1662 11.1101 31.0818 12.4151 31.6169C13.7201 32.152 15.1536 32.2824 16.5324 31.9914C17.9111 31.7003 19.1726 31.0011 20.1554 29.9831L28.317 35.2759C27.7706 36.6983 27.6899 38.2598 28.0868 39.7318C28.4837 41.2037 29.3373 42.5089 30.5226 43.4561C31.7079 44.4033 33.1627 44.9428 34.6739 44.9957C36.1852 45.0486 37.6735 44.612 38.921 43.7499C40.1685 42.8877 41.1096 41.6454 41.6066 40.2047C42.1036 38.764 42.1304 37.2006 41.6829 35.7434C41.2355 34.2863 40.3374 33.0119 39.1202 32.1069C37.9029 31.2018 36.4304 30.7137 34.9183 30.7139ZM34.9183 7.85223C35.7587 7.85223 36.5802 8.10363 37.279 8.57465C37.9777 9.04566 38.5224 9.71513 38.844 10.4984C39.1656 11.2817 39.2497 12.1436 39.0858 12.9751C38.9218 13.8066 38.5171 14.5704 37.9229 15.1699C37.3286 15.7693 36.5715 16.1776 35.7472 16.343C34.923 16.5084 34.0686 16.4235 33.2922 16.0991C32.5157 15.7746 31.8521 15.2252 31.3852 14.5203C30.9183 13.8154 30.6691 12.9866 30.6691 12.1388C30.6703 11.0023 31.1184 9.91276 31.915 9.10915C32.7116 8.30554 33.7917 7.85351 34.9183 7.85223ZM15.0888 29.2851C14.2484 29.2851 13.4268 29.0337 12.7281 28.5627C12.0293 28.0916 11.4847 27.4222 11.1631 26.6389C10.8415 25.8556 10.7573 24.9938 10.9213 24.1622C11.0852 23.3307 11.4899 22.5669 12.0842 21.9674C12.6784 21.368 13.4356 20.9597 14.2598 20.7943C15.0841 20.6289 15.9384 20.7138 16.7149 21.0382C17.4913 21.3627 18.1549 21.9121 18.6218 22.617C19.0887 23.3219 19.338 24.1507 19.338 24.9985C19.3367 26.135 18.8886 27.2246 18.092 28.0282C17.2954 28.8318 16.2153 29.2838 15.0888 29.2851ZM34.9183 42.1448C34.0778 42.1448 33.2563 41.8934 32.5575 41.4224C31.8588 40.9514 31.3141 40.2819 30.9925 39.4986C30.6709 38.7153 30.5868 37.8535 30.7507 37.0219C30.9147 36.1904 31.3194 35.4266 31.9136 34.8272C32.5079 34.2277 33.265 33.8194 34.0893 33.654C34.9135 33.4886 35.7679 33.5735 36.5443 33.8979C37.3208 34.2224 37.9844 34.7718 38.4513 35.4767C38.9182 36.1817 39.1674 37.0104 39.1674 37.8582C39.1662 38.9947 38.7181 40.0843 37.9215 40.8879C37.1249 41.6915 36.0448 42.1435 34.9183 42.1448Z"
              />
            </svg>
            <span class="text-sm">仅导出可分享书签</span>
          </label>
        </div>
        <div>
          <div class="flex flex-wrap">
            <button
              v-for="group of allGroups"
              :key="group"
              title="toggle select group"
              class="p-1 mt-2 ml-2 flex items-center border-2 border-green-400 space-x-1 rounded"
              :class="{
                'text-green-600 hover:text-white hover:bg-green-400 ': !selectGroups.has(group),
                'text-white bg-green-400 hover:bg-green-600': selectGroups.has(group)
              }"
              @click="toggleGroupHandler(group)"
            >
              <svg
                class="w-5 h-5"
                viewBox="0 0 50 50"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M42.6412 15.0387C42.6367 15.0302 42.6333 15.0215 42.6284 15.0131C42.6265 15.0096 42.6239 15.0062 42.6218 15.0027C42.374 14.5747 42.0172 14.221 41.5882 13.9781L26.3576 5.35549C25.9426 5.12238 25.4753 5 25 5C24.5247 5 24.0574 5.12238 23.6424 5.35549L8.41144 13.9781C7.98088 14.2222 7.6231 14.5778 7.37523 15.0081C7.37263 15.0128 7.36935 15.017 7.36658 15.0218C7.3626 15.0293 7.35948 15.0372 7.35533 15.0448C7.12275 15.4609 7.00039 15.9302 7 16.4075V33.5903C7.00036 34.0848 7.13125 34.5703 7.37928 34.9972C7.62731 35.424 7.98358 35.7769 8.41162 36.0196L23.6426 44.6422C24.0262 44.8581 24.4555 44.9788 24.8948 44.9944C24.9263 44.9969 24.9576 44.9997 24.9896 45H25.0021C25.0457 45 25.0888 44.9976 25.1314 44.9936C25.5617 44.9743 25.9817 44.854 26.3576 44.6422L41.5884 36.0196C42.0165 35.7769 42.3728 35.424 42.6209 34.9971C42.8689 34.5701 42.9998 34.0845 43 33.59V16.4075C42.9996 15.9278 42.876 15.4564 42.6412 15.0389V15.0387ZM25 7.78479L38.8017 15.5984L33.5021 18.6287L19.5377 10.8771L25 7.78479ZM25.1575 23.3998L11.2194 15.5864L16.6991 12.4842L30.6774 20.2436L25.1575 23.3998ZM26.4057 41.417L26.5418 25.8138L32.1 22.6358V29.2684C32.1 29.638 32.2458 29.9925 32.5055 30.2538C32.7652 30.5151 33.1174 30.662 33.4846 30.662C33.8518 30.662 34.204 30.5151 34.4636 30.2538C34.7233 29.9925 34.8692 29.638 34.8692 29.2684V21.0524L40.2308 17.9868V33.5902L26.4057 41.417Z"
                />
              </svg>
              <span class="text-sm">{{ group }}</span>
            </button>
          </div>
        </div>
      </section>
      <section class="p-8">
        <h2 class="text-2xl font-bold py-4 text-gray-800">
          相关信息
        </h2>
        <ul class="list-disc">
          <li class="text-base">
            项目简介：
            <a
              class="text-blue-400"
              href="https://github.com/Benbinbin/TagDown/blob/main/README-CN.md"
              target="_blank"
            >README</a>
          </li>
          <li class="text-base">
            代码仓库：
            <a
              class="text-blue-400"
              href="https://github.com/Benbinbin/TagDown"
              target="_blank"
            >Github</a>
          </li>
          <li class="text-base">
            许可协议：
            <a
              class="text-blue-400"
              href="https://github.com/Benbinbin/TagDown/blob/main/LICENSE"
              target="_blank"
            >MIT License</a>
          </li>
          <li class="text-base">
            反馈邮箱：
            <a
              class="text-blue-400"
              href="mailto:benthomsonbin@gmail.com"
            >benthomsonbin@gmail.com</a>
          </li>
        </ul>
      </section>
    </main>
    <transition name="dissolve">
      <div
        v-if="showMsg && msg"
        class="fixed top-4 right-4 z-10 p-4 text-white rounded shadow"
        :class="{
          'bg-green-400': msg.state === true,
          'bg-red-400': msg.state === false
        }"
      >
        {{ msg.title }}
      </div>
    </transition>
    <PromptModal
      v-if="showDeleteWebDAVConfirmModal"
      v-model:show="showDeleteWebDAVConfirmModal"
      @result="getDeleteWebDAVResult"
    >
      <template #title>
        <h2 class="p-4 text-xl font-bold">
          删除 webDAV 账号信息
        </h2>
      </template>
      <template #msg>
        <p class="p-2 text-base text-center">
          该操作不可恢复
        </p>
      </template>
    </PromptModal>
    <WebdavFileModal
      v-if="showWebdavFileModal"
      v-model:show="showWebdavFileModal"
      :files-arr="webDAVFilesArr"
      @result="getRecoverIndexedDBResult"
    />
    <PromptModal
      v-if="showDeleteIndexedDBConfirmModal"
      v-model:show="showDeleteIndexedDBConfirmModal"
      @result="getDeleteIndexedDBResult"
    >
      <template #title>
        <h2 class="p-4 text-xl font-bold">
          删除数据库
        </h2>
      </template>
      <template #msg>
        <p class="p-2 text-base text-center">
          该操作不可恢复
        </p>
      </template>
    </PromptModal>
  </div>
</template>

<script>
import {
  ref, computed, inject, onMounted,
} from 'vue';
import {
  importDB, exportDB, importInto, peakImportFile,
} from 'dexie-export-import';
import PromptModal from './Modal/PromptModal.vue';
import WebdavFileModal from './Modal/WebdavFileModal.vue';
import useWebDAV from '../composables/useWebDAV';

export default {
  components: {
    PromptModal,
    WebdavFileModal,
  },
  setup(props) {
    const {
      setWebDAVInfo, getWebDAVInfo, clearWebDAVInfo, setWebDAVSync, getWebDAVSync, getWebDAVUpdateTime, createWebDAVClient, checkWebDAVConnect, getWebDAVFolder, getWebDAVFile, writeWebDAVFile,
    } = useWebDAV();

    const db = inject('db');

    /**
     * popup msg
     */
    const showMsg = ref(false);
    const msg = ref(null);

    const setMsg = (state, title, duration = 1000) => {
      msg.value = {
        state,
        title,
      };
      showMsg.value = true;
      let timer = setTimeout(() => {
        showMsg.value = false;
        msg.value = null;
        timer = null;
      }, duration);
    };

    /**
     * export and import indexedDB manual
     */
    const exportJsonFile = (blob, fileName) => {
      if (!blob) return;
      const a = document.createElement('a');
      const url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = `${fileName}.json`;
      a.click();
    };

    // export indexedDb
    const exportDatabase = async () => {
      const blob = await exportDB(db, {
        prettyJson: true,
      });
      const date = new Date();
      const filename = `tagdown_${date.getTime()}`;
      exportJsonFile(blob, filename);
    };

    // import indexedDb
    const importDatabase = ref(null);
    const importDatabaseHandler = () => {
      if (importDatabase.value) importDatabase.value.click();
    };

    const inputFile = async (event) => {
      if (!event.target.files || event.target.files.length === 0) return;
      const file = event.target.files[0];
      await importInto(db, file, {
        overwriteValues: true,
      }).then(() => {
        console.log('import database successful!');
        setMsg(true, '成功');
      }).catch((err) => {
        console.log(err);
        setMsg(false, '失败');
      });
    };

    /**
     * sync indexedDB by WebDAV
     */
    const showWebDAVInfo = ref(false);
    const webDAVState = ref('');

    const webDAVUrl = ref('');
    const webDAVUsername = ref('');
    const webDAVPassword = ref('');
    const webDAVInfoIntegrity = computed(() => {
      if (!webDAVUrl.value || !webDAVUsername.value || !webDAVPassword.value) return false;
      return true;
    });

    const webDAVSync = ref('auto');

    const webDAVBakcupTime = ref(null);
    const webDAVBackupTimeString = computed(() => {
      if (!webDAVBakcupTime.value) return '无记录';
      const date = new Date(webDAVBakcupTime.value);
      return date.toLocaleString();
    });

    const webDAVClient = ref(null);

    // check the webDAV state by sending a request to webDAV server
    const getWebDAVState = async () => {
      if (!webDAVClient.value) return;
      const result = await checkWebDAVConnect(webDAVClient.value);
      console.log(result);
      showWebDAVInfo.value = !result.state;
      webDAVState.value = result.msg;
      if (webDAVState.value === '连接成功') {
        webDAVBakcupTime.value = await getWebDAVUpdateTime(webDAVClient.value, '/tagdown_backup');
      } else {
        webDAVBakcupTime.value = null;
      }
    };

    // get webDAV data from chrome.storage
    const setWebDAVInfoHandler = async () => {
      // webDAV sync
      const webDAVSyncInit = await getWebDAVSync();
      if (webDAVSyncInit) webDAVSync.value = webDAVSyncInit;

      // webDAV information
      const webDAVInfo = await getWebDAVInfo();

      if (!webDAVInfo) {
        showWebDAVInfo.value = true;
        webDAVState.value = '未添加';
        webDAVBakcupTime.value = null;
      } else {
        webDAVUrl.value = webDAVInfo.url;
        webDAVUsername.value = webDAVInfo.username;
        webDAVPassword.value = webDAVInfo.password;
      }
    };

    onMounted(async () => {
      await setWebDAVInfoHandler();
      // const webDAVBakcupTimeInit = await getWebDAVBakcupTime();
      // if (webDAVBakcupTimeInit) webDAVBakcupTime.value = webDAVBakcupTimeInit;

      if (!webDAVUrl.value || !webDAVUsername.value || !webDAVPassword.value) return;
      webDAVClient.value = createWebDAVClient(webDAVUrl.value, webDAVUsername.value, webDAVPassword.value);
      getWebDAVState();
    });

    const toggleWebDAVInfoHandler = async () => {
      await setWebDAVInfoHandler();
      showWebDAVInfo.value = !showWebDAVInfo.value;
    };

    // set webDAV information
    const saveWebDAVInfoHandler = async () => {
      await setWebDAVSync(webDAVSync.value);
      await setWebDAVInfo(webDAVUrl.value, webDAVUsername.value, webDAVPassword.value);

      webDAVClient.value = createWebDAVClient(webDAVUrl.value, webDAVUsername.value, webDAVPassword.value);
      getWebDAVState();
    };

    // clear WebDAV information
    const showDeleteWebDAVConfirmModal = ref(false);
    const clearWebDAVInfoHandler = () => {
      showDeleteWebDAVConfirmModal.value = true;
    };

    const getDeleteWebDAVResult = async (value) => {
      if (value) {
        await clearWebDAVInfo();
        const webDAVInfo = await getWebDAVInfo();
        // console.log(webDAVInfo);
        if (!webDAVInfo) {
          webDAVUrl.value = '';
          webDAVUsername.value = '';
          webDAVPassword.value = '';
          webDAVState.value = '未添加';
          webDAVBakcupTime.value = null;
        }
      }
    };

    // create a new database backup by webDAV
    const createDatabaseBackupHandler = async () => {
      const blob = await exportDB(db, {
        prettyJson: true,
      });
      if (!blob) return;
      const date = new Date();
      const filename = `tagdown_${date.getTime()}.json`;
      const result = await writeWebDAVFile(webDAVClient.value, '/tagdown_backup', filename, blob);
      setMsg(result.state, result.msg);
      if (result.state) webDAVBakcupTime.value = await getWebDAVUpdateTime(webDAVClient.value, '/tagdown_backup');
    };

    // get the database backup files list in webDAV server
    const webDAVFilesArr = ref([]);
    const showWebdavFileModal = ref(false);
    const getDatabaseBackupHandler = async () => {
      webDAVFilesArr.value = await getWebDAVFolder(webDAVClient.value, '/tagdown_backup');
      showWebdavFileModal.value = true;
    };

    const getRecoverIndexedDBResult = async (value) => {
      if (!value.state || !value.filename) return;
      const file = await getWebDAVFile(webDAVClient.value, `/tagdown_backup/${value.filename}`);
      if (!file) return;
      const blob = new Blob([file], { type: 'application/json' });
      await importInto(db, blob, {
        overwriteValues: true,
      }).then(() => {
        console.log('import database successful!');
        setMsg(true, '成功');
      }).catch((err) => {
        console.log(err);
        setMsg(false, '失败');
      });
    };

    /**
     * delete indexedDb
     */
    const showDeleteIndexedDBConfirmModal = ref(false);

    const deleteDatabaseHandler = () => {
      showDeleteIndexedDBConfirmModal.value = true;
    };

    const getDeleteIndexedDBResult = (value) => {
      if (value) {
        db.delete().then(() => {
          console.log('database delete successful!');
          setMsg(true, '成功');
        }).catch((err) => {
          console.log(err);
          setMsg(false, '失败');
        })
          .finally(async () => {
            if (!db.isOpen()) {
              // console.log('the database has closed');
              await db.open();
              // console.log(db.isOpen());
            }
          });
      }
    };

    /**
     * export bookmarks
     */
    // export bookmarks by tags
    const tagShareable = ref(false);
    const allTags = ref([]);
    const selectTags = ref(new Set());
    onMounted(async () => {
      allTags.value = await db.bookmark.orderBy('tags').uniqueKeys();
    });
    const toggleTagHandler = (tag) => {
      if (selectTags.value.has(tag)) {
        selectTags.value.delete(tag);
      } else {
        selectTags.value.add(tag);
      }
    };

    const getBookmarksByTag = (tag, shareableIds = []) => new Promise((resolve, reject) => {
      if (tagShareable.value) {
        db.bookmark.where('tags').equals(tag).filter((item) => shareableIds.includes(item.id)).toArray()
          .then((result) => {
            resolve({
              tag,
              bookmarks: result,
            });
          });
      } else {
        db.bookmark.where('tags').equals(tag).toArray().then((result) => {
          resolve({
            tag,
            bookmarks: result,
          });
        });
      }
    });

    // export bookmarks by groups
    const groupShareable = ref(false);
    const allGroups = ref([]);
    const selectGroups = ref(new Set());
    onMounted(async () => {
      allGroups.value = await db.bookmark.orderBy('groups').uniqueKeys();
    });
    const toggleGroupHandler = (group) => {
      if (selectGroups.value.has(group)) {
        selectGroups.value.delete(group);
      } else {
        selectGroups.value.add(group);
      }
    };

    const getBookmarksByGroup = (group, shareableIds = []) => new Promise((resolve, reject) => {
      if (groupShareable.value) {
        db.bookmark.where('groups').equals(group).filter((item) => shareableIds.includes(item.id)).toArray()
          .then((result) => {
            resolve({
              group,
              bookmarks: result,
            });
          });
      } else {
        db.bookmark.where('groups').equals(group).toArray().then((result) => {
          resolve({
            group,
            bookmarks: result,
          });
        });
      }
    });

    const getShareableIds = async () => {
      const result = await db.share.where('share').equals(1).primaryKeys();
      return result;
    };

    const exportBookmarks = async (type) => {
      console.log('export bookmarks');
      let result = [];
      const promiseArr = [];
      let shareableIds = [];

      if (type === 'tag' && selectTags.value.size > 0) {
        const selectTagsArr = [...selectTags.value];
        if (tagShareable.value) {
          shareableIds = await getShareableIds();
        }
        selectTagsArr.forEach((tag) => {
          promiseArr.push(getBookmarksByTag(tag, shareableIds));
        });
        result = await Promise.all(promiseArr);
      } else if (type === 'group' && selectGroups.value.size > 0) {
        const selectGroupsArr = [...selectGroups.value];
        if (groupShareable.value) {
          shareableIds = await getShareableIds();
        }
        selectGroupsArr.forEach((group) => {
          promiseArr.push(getBookmarksByGroup(group, shareableIds));
        });
        result = await Promise.all(promiseArr);
      }
      if (result.length === 0) return;
      const jsonFile = JSON.stringify(result, null, 2);
      const blob = new Blob([jsonFile], { type: 'application/json' });
      const date = new Date();
      const filename = `bookmarks_by_${type}_${date.getTime()}`;
      exportJsonFile(blob, filename);
    };

    return {
      showMsg,
      msg,
      exportDatabase,
      importDatabase,
      importDatabaseHandler,
      inputFile,
      showWebDAVInfo,
      webDAVState,
      webDAVUrl,
      webDAVUsername,
      webDAVPassword,
      webDAVInfoIntegrity,
      webDAVSync,
      webDAVBackupTimeString,
      toggleWebDAVInfoHandler,
      saveWebDAVInfoHandler,
      clearWebDAVInfoHandler,
      showDeleteWebDAVConfirmModal,
      getDeleteWebDAVResult,
      createDatabaseBackupHandler,
      webDAVFilesArr,
      showWebdavFileModal,
      getDatabaseBackupHandler,
      getRecoverIndexedDBResult,
      deleteDatabaseHandler,
      showDeleteIndexedDBConfirmModal,
      getDeleteIndexedDBResult,
      tagShareable,
      allTags,
      selectTags,
      toggleTagHandler,
      groupShareable,
      allGroups,
      selectGroups,
      toggleGroupHandler,
      exportBookmarks,
    };
  },
};
</script>

<style lang="scss" scoped>
.dissolve-enter-from,
.dissolve-leave-to {
  opacity: 0;
}

.dissolve-enter-active,
.dissolve-leave-active {
  transition: opacity 0.5s ease-out;
}

.input-style {
  @apply border-2 border-gray-100 rounded;
}

label,
button {
  user-select: none;
}
</style>
