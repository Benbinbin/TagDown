<template>
  <div>
    <header class="p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800">
        TagDown Setting
      </h1>
    </header>
    <main class="container p-4 mx-auto">
      <section class="p-8 border-b-2 border-gray-200">
        <h2 class="text-2xl font-bold py-4 text-gray-800">
          IndexedDB 数据库
        </h2>
        <div class="flex items-center space-x-4">
          <button
            title="export indexedDB database"
            class="px-2 py-1 flex items-center text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
            @click="exportDatabase"
          >
            <svg
              class="w-5 h-5"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M16.3349 15.0472C16.1999 14.9131 16.0927 14.7538 16.0197 14.5786C15.9466 14.4033 15.909 14.2155 15.909 14.0258C15.9091 13.8361 15.9467 13.6482 16.0199 13.473C16.093 13.2978 16.2002 13.1385 16.3353 13.0044L23.9716 5.42291C24.2444 5.15212 24.6143 5 25 5C25.3857 5 25.7556 5.15212 26.0284 5.42291L33.6647 13.0044C33.8023 13.138 33.9118 13.2973 33.9869 13.4732C34.0621 13.6491 34.1013 13.838 34.1024 14.0291C34.1035 14.2201 34.0664 14.4095 33.9933 14.5862C33.9202 14.7629 33.8125 14.9234 33.6765 15.0585C33.5405 15.1936 33.3788 15.3006 33.2009 15.3732C33.0229 15.4459 32.8322 15.4827 32.6399 15.4817C32.4475 15.4806 32.2572 15.4417 32.0801 15.3671C31.903 15.2925 31.7425 15.1838 31.608 15.0472L26.4545 9.93102V26.6667C26.4545 27.0498 26.3013 27.4172 26.0285 27.6881C25.7557 27.959 25.3858 28.1111 25 28.1111C24.6142 28.1111 24.2443 27.959 23.9715 27.6881C23.6987 27.4172 23.5455 27.0498 23.5455 26.6667V9.93102L18.392 15.0472C18.2569 15.1814 18.0966 15.2878 17.9201 15.3604C17.7436 15.433 17.5545 15.4704 17.3635 15.4704C17.1724 15.4704 16.9833 15.433 16.8068 15.3604C16.6303 15.2878 16.47 15.1814 16.3349 15.0472ZM38.0909 19.4445H33.7273C33.3415 19.4445 32.9715 19.5967 32.6988 19.8675C32.426 20.1384 32.2727 20.5058 32.2727 20.8889C32.2727 21.272 32.426 21.6394 32.6988 21.9103C32.9715 22.1812 33.3415 22.3334 33.7273 22.3334H38.0909V41.1111H11.9091V22.3334H16.2727C16.6585 22.3334 17.0285 22.1812 17.3012 21.9103C17.574 21.6394 17.7273 21.272 17.7273 20.8889C17.7273 20.5058 17.574 20.1384 17.3012 19.8675C17.0285 19.5967 16.6585 19.4445 16.2727 19.4445H11.9091C11.1378 19.4453 10.3984 19.75 9.85301 20.2916C9.30764 20.8331 9.00087 21.5674 9 22.3334V41.1111C9.00087 41.877 9.30764 42.6113 9.85301 43.1529C10.3984 43.6945 11.1378 43.9991 11.9091 44H38.0909C38.8622 43.9991 39.6016 43.6945 40.147 43.1529C40.6924 42.6113 40.9991 41.877 41 41.1111V22.3334C40.9991 21.5674 40.6924 20.8331 40.147 20.2916C39.6016 19.75 38.8622 19.4453 38.0909 19.4445Z"
              />
            </svg>
            <span class="text-base">导出数据库</span>
          </button>
          <input
            id="importDatabase"
            ref="importDatabase"
            type="file"
            name="importDatabase"
            class="hidden"
            accept=".json"
            @change="inputFile"
          >
          <button
            title="import indexedDB database"
            class="px-2 py-1 flex items-center text-base text-white bg-green-400 hover:bg-green-600 space-x-1 rounded"
            @click="importDatabaseHandler"
          >
            <svg
              class="w-5 h-5"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M33.2496 28.4169C33.5622 28.7295 33.7378 29.1534 33.7378 29.5955C33.7378 30.0376 33.5622 30.4616 33.2496 30.7742L26.1785 37.8452C26.169 37.8548 26.1587 37.8629 26.149 37.8721C26.1194 37.9002 26.0898 37.9283 26.0583 37.9542C26.0448 37.9652 26.0302 37.975 26.0165 37.9854C25.9871 38.0081 25.9579 38.031 25.9269 38.0517C25.9156 38.0594 25.9033 38.0656 25.8917 38.0729C25.8573 38.0948 25.8229 38.1165 25.7867 38.1358C25.7783 38.1404 25.769 38.1442 25.7604 38.1485C25.7208 38.169 25.6806 38.1887 25.639 38.2058C25.6333 38.2083 25.6273 38.21 25.6215 38.2121C25.577 38.2303 25.5317 38.2466 25.4858 38.2608C25.4798 38.2629 25.4735 38.2637 25.4677 38.2656C25.4217 38.2793 25.3751 38.291 25.3281 38.3006C25.3146 38.3033 25.3006 38.3046 25.2871 38.3069C25.2473 38.314 25.2073 38.3208 25.1663 38.3248C25.0556 38.336 24.9442 38.336 24.8335 38.3248C24.7925 38.3206 24.7525 38.3137 24.7127 38.3069C24.6992 38.3044 24.6854 38.3033 24.6721 38.3006C24.6249 38.291 24.5782 38.2793 24.5321 38.2656C24.5262 38.2637 24.5202 38.2627 24.5142 38.2608C24.4683 38.2467 24.4232 38.2305 24.3787 38.2123L24.361 38.206C24.3198 38.1885 24.2793 38.1693 24.2396 38.1485C24.231 38.1442 24.2219 38.1404 24.2133 38.136C24.1776 38.1163 24.1426 38.0952 24.1083 38.0729C24.0967 38.0656 24.0844 38.0594 24.0729 38.0517C24.0421 38.0308 24.0129 38.0081 23.9835 37.9854C23.9698 37.975 23.9552 37.9652 23.9419 37.9542C23.9106 37.9279 23.8803 37.9005 23.851 37.8721C23.8412 37.8629 23.831 37.8548 23.8215 37.8452L16.7504 30.7742C16.4378 30.4616 16.2621 30.0376 16.2621 29.5956C16.2621 29.1535 16.4376 28.7295 16.7502 28.4169C17.0628 28.1043 17.4867 27.9286 17.9288 27.9286C18.3709 27.9285 18.7949 28.1041 19.1075 28.4167L23.3333 32.6431V20C23.3333 19.558 23.5089 19.134 23.8215 18.8215C24.134 18.5089 24.558 18.3333 25 18.3333C25.442 18.3333 25.866 18.5089 26.1785 18.8215C26.4911 19.134 26.6667 19.558 26.6667 20V32.6431L30.8925 28.4169C31.2051 28.1044 31.629 27.9289 32.071 27.9289C32.513 27.9289 32.937 28.1044 33.2496 28.4169V28.4169ZM45 13.3333V41.6667C44.999 42.5504 44.6475 43.3977 44.0226 44.0226C43.3977 44.6475 42.5504 44.999 41.6667 45H8.33333C7.44958 44.999 6.60231 44.6475 5.97741 44.0226C5.3525 43.3977 5.00099 42.5504 5 41.6667V13.3333C5.00019 13.2718 5.00374 13.2103 5.01062 13.1492C5.0125 13.134 5.01562 13.119 5.01771 13.1038C5.02396 13.0577 5.03146 13.0121 5.04167 12.9673C5.04542 12.9502 5.05021 12.9337 5.05458 12.9167C5.07001 12.8566 5.08879 12.7974 5.11083 12.7394C5.12667 12.6983 5.14403 12.658 5.16292 12.6185C5.1675 12.6085 5.17083 12.5977 5.17604 12.5879L8.50938 5.92125C8.6478 5.64443 8.86057 5.41162 9.12384 5.24891C9.38712 5.0862 9.6905 5.00001 10 5H40C40.3095 5.00001 40.6129 5.0862 40.8762 5.24891C41.1394 5.41162 41.3522 5.64443 41.4906 5.92125L44.824 12.5879C44.829 12.5979 44.8323 12.6085 44.8373 12.6185C44.8827 12.7142 44.9189 12.814 44.9454 12.9165C44.9496 12.9335 44.9546 12.9504 44.9583 12.9675C44.9683 13.0121 44.9758 13.0573 44.9823 13.1033C44.9844 13.1185 44.9875 13.134 44.9894 13.1492C44.9963 13.2103 44.9998 13.2718 45 13.3333V13.3333ZM9.36333 11.6667H40.6367L38.97 8.33333H11.03L9.36333 11.6667ZM41.6687 41.6667L41.6667 15H8.33333V41.6667H41.6687Z"
              />
            </svg>

            <span class="text-base">导入数据库</span>
          </button>
          <button
            title="import indexedDB database"
            class="px-2 py-1 flex items-center text-base text-white bg-red-400 hover:bg-red-600 space-x-1 rounded"
            @click="deleteDatabaseHandler"
          >
            <svg
              class="w-5 h-5"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M41.5 11H34.0007V9.5C33.9994 8.30694 33.5249 7.16312 32.6813 6.3195C31.8376 5.47588 30.6938 5.00134 29.5007 5H20.5007C19.3077 5.00134 18.1639 5.47588 17.3202 6.3195C16.4766 7.16312 16.0021 8.30694 16.0007 9.5V11H8.5C8.10217 11 7.72064 11.158 7.43934 11.4393C7.15804 11.7206 7 12.1022 7 12.5C7 12.8978 7.15804 13.2794 7.43934 13.5607C7.72064 13.842 8.10217 14 8.5 14H10V41C10.0009 41.7954 10.3173 42.5579 10.8797 43.1203C11.4421 43.6827 12.2046 43.9991 13 44H37C37.7954 43.9991 38.5579 43.6827 39.1203 43.1203C39.6827 42.5579 39.9991 41.7954 40 41V14H41.5C41.8978 14 42.2794 13.842 42.5607 13.5607C42.842 13.2794 43 12.8978 43 12.5C43 12.1022 42.842 11.7206 42.5607 11.4393C42.2794 11.158 41.8978 11 41.5 11ZM19.0007 9.5C19.0012 9.10233 19.1594 8.72109 19.4406 8.43989C19.7218 8.15869 20.1031 8.0005 20.5007 8H29.5007C29.8984 8.0005 30.2797 8.15869 30.5609 8.43989C30.8421 8.72109 31.0003 9.10233 31.0007 9.5V11H19.0007V9.5ZM37 41H13V14H37V41ZM22.0007 21.5V33.5C22.0007 33.8978 21.8427 34.2794 21.5614 34.5607C21.2801 34.842 20.8986 35 20.5007 35C20.1029 35 19.7214 34.842 19.4401 34.5607C19.1588 34.2794 19.0007 33.8978 19.0007 33.5V21.5C19.0007 21.1022 19.1588 20.7206 19.4401 20.4393C19.7214 20.158 20.1029 20 20.5007 20C20.8986 20 21.2801 20.158 21.5614 20.4393C21.8427 20.7206 22.0007 21.1022 22.0007 21.5ZM31.0007 21.5V33.5C31.0007 33.8978 30.8427 34.2794 30.5614 34.5607C30.2801 34.842 29.8986 35 29.5007 35C29.1029 35 28.7214 34.842 28.4401 34.5607C28.1588 34.2794 28.0007 33.8978 28.0007 33.5V21.5C28.0007 21.1022 28.1588 20.7206 28.4401 20.4393C28.7214 20.158 29.1029 20 29.5007 20C29.8986 20 30.2801 20.158 30.5614 20.4393C30.8427 20.7206 31.0007 21.1022 31.0007 21.5Z"
              />
            </svg>

            <span class="text-base">删除数据库</span>
          </button>
        </div>
      </section>
    </main>
    <transition name="dissolve">
      <div
        v-if="showMsg && msg"
        class="fixed top-4 right-4 z-10 p-4 text-white rounded shadow"
        :class="{
          'bg-green-400': msg.state===true,
          'bg-red-400': msg.state===false
        }"
      >
        {{ msg.title }}
      </div>
    </transition>
  </div>
</template>

<script>
import { ref, inject } from 'vue';
import {
  importDB, exportDB, importInto, peakImportFile,
} from 'dexie-export-import';

export default {
  setup(props) {
    const db = inject('db');

    // msg
    const showMsg = ref(false);
    const msg = ref(null);

    const setMsg = (state, title, duration = 1000) => {
      msg.value = {
        state,
        title,
      };
      showMsg.value = true;
      let timer = setTimeout(() => {
        showMsg.value = false;
        msg.value = null;
        timer = null;
      }, duration);
    };

    // export indexedDb
    const exportDatabase = async () => {
      const blob = await exportDB(db, {
        prettyJson: true,
      });

      const date = new Date();
      const a = document.createElement('a');
      const url = window.URL.createObjectURL(blob);
      a.href = url;
      a.download = `tagdown_${date.toLocaleDateString()}.json`;
      a.click();
    };

    // import indexedDb
    const importDatabase = ref(null);
    const importDatabaseHandler = () => {
      if (importDatabase.value) importDatabase.value.click();
    };

    const inputFile = async (event) => {
      if (!event.target.files || event.target.files.length === 0) return;
      const file = event.target.files[0];
      await importInto(db, file, {
        overwriteValues: true,
      }).then(() => {
        console.log('import database successful!');
        setMsg(true, '成功');
      }).catch((err) => {
        console.log(err);
        setMsg(false, '失败');
      });
    };

    // delete indexedDb
    const deleteDatabaseHandler = () => {
      db.delete().then(() => {
        console.log('database delete successful!');
        setMsg(true, '成功');
      }).catch((err) => {
        console.log(err);
        setMsg(false, '失败');
      });
    };

    return {
      showMsg,
      msg,
      exportDatabase,
      importDatabase,
      importDatabaseHandler,
      inputFile,
      deleteDatabaseHandler,
    };
  },
};
</script>

<style lang="scss" scoped>
.dissolve-enter-from,
.dissolve-leave-to {
  opacity: 0
}

.dissolve-enter-active,
.dissolve-leave-active {
  transition: opacity 0.5s ease-out;
}
</style>
