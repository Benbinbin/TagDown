<template>
  <div class="flex flex-col bg-gray-50 hover:bg-gray-100 space-y-4 rounded">
    <div class="px-8 pt-6 space-y-2">
      <div class="flex justify-between items-start space-x-4">
        <h3 class="text-xl font-bold text-gray-800">
          {{ gistRecord.filename }}
        </h3>
        <button
          title="sync gist"
          class="p-1 text-gray-400 hover:bg-gray-200 rounded"
          :class="{
            'opacity-10': !token
          }"
          :disabled="!token || syncGistState"
          @click="syncGistHandler"
        >
          <svg
            class="w-5 h-5"
            :class="{
              'animate-spin': syncGistState
            }"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M43.6827 21.178C43.6602 21.181 43.6383 21.1852 43.6155 21.1874C43.5652 21.1923 43.5147 21.1949 43.464 21.1949H34.248C33.8407 21.1949 33.45 21.0368 33.1619 20.7554C32.8739 20.4739 32.712 20.0922 32.712 19.6942C32.712 19.2962 32.8739 18.9145 33.1619 18.6331C33.45 18.3517 33.8407 18.1935 34.248 18.1935H39.7557L35.861 14.3886C32.9783 11.5783 29.0723 10.0001 25 10.0001C20.9277 10.0001 17.0217 11.5783 14.139 14.3886C13.8509 14.67 13.4602 14.8281 13.0527 14.8281C12.6453 14.8281 12.2546 14.67 11.9665 14.3886C11.6784 14.1071 11.5166 13.7253 11.5166 13.3273C11.5166 12.9292 11.6784 12.5475 11.9665 12.266C15.4259 8.89383 20.1132 7 25 7C29.8868 7 34.5741 8.89383 38.0335 12.266L41.928 16.071V10.6901C41.928 10.2921 42.0898 9.9104 42.3779 9.62897C42.6659 9.34754 43.0566 9.18943 43.464 9.18943C43.8714 9.18943 44.2621 9.34754 44.5501 9.62897C44.8382 9.9104 45 10.2921 45 10.6901V19.6931C45 19.743 44.9973 19.7929 44.9923 19.8426C44.9904 19.8627 44.9864 19.8822 44.9835 19.9021C44.9795 19.9308 44.9758 19.9595 44.97 19.9878C44.9654 20.0112 44.9587 20.0339 44.9528 20.0572C44.9466 20.0816 44.9412 20.106 44.9336 20.1304C44.9265 20.1529 44.9178 20.1748 44.9098 20.197C44.9009 20.221 44.8929 20.2452 44.8829 20.269C44.874 20.2893 44.8639 20.3086 44.8545 20.3285C44.8427 20.3532 44.8314 20.378 44.818 20.4022C44.808 20.4204 44.7967 20.4378 44.7859 20.4555C44.7711 20.4798 44.7571 20.5044 44.7406 20.5282C44.7279 20.5466 44.7137 20.5639 44.7003 20.5819C44.684 20.6035 44.6686 20.6252 44.6511 20.646C44.6289 20.6725 44.6047 20.6974 44.5807 20.7224C44.5701 20.7331 44.5611 20.7447 44.5501 20.7552C44.5398 20.7653 44.5284 20.774 44.5177 20.7839C44.4918 20.8077 44.4659 20.8318 44.4382 20.8539C44.4179 20.8704 44.3963 20.8848 44.3752 20.9C44.356 20.9139 44.3374 20.9285 44.3176 20.9415C44.294 20.9569 44.2698 20.9702 44.2458 20.9841C44.2266 20.9951 44.2082 21.0068 44.1886 21.0171C44.1646 21.0297 44.1402 21.0402 44.1158 21.0514C44.0947 21.0612 44.0738 21.0715 44.0521 21.0803C44.0289 21.0897 44.0051 21.0972 43.9814 21.1054C43.9578 21.1139 43.9344 21.1227 43.91 21.1298C43.8868 21.1368 43.863 21.1418 43.8394 21.1476C43.8144 21.1538 43.7896 21.1608 43.7641 21.1657C43.7372 21.1709 43.71 21.1739 43.6827 21.1778V21.178ZM35.861 35.6113C32.9783 38.4215 29.0723 39.9997 25 39.9997C20.9277 39.9997 17.0217 38.4215 14.139 35.6113L10.2443 31.8063H15.752C16.1593 31.8063 16.55 31.6482 16.8381 31.3667C17.1261 31.0853 17.288 30.7036 17.288 30.3056C17.288 29.9076 17.1261 29.5259 16.8381 29.2444C16.55 28.963 16.1593 28.8049 15.752 28.8049H6.536C6.52448 28.8049 6.51353 28.8064 6.50201 28.8068C6.46304 28.8075 6.42425 28.8086 6.38547 28.8124C6.35897 28.8148 6.33305 28.8195 6.30694 28.8235C6.28352 28.8268 6.2599 28.8295 6.23667 28.834C6.20883 28.8392 6.18176 28.8467 6.15449 28.8535C6.13337 28.8587 6.11187 28.8632 6.09075 28.8694C6.06483 28.8771 6.03968 28.8867 6.01414 28.8957C5.99225 28.9034 5.97017 28.9103 5.94848 28.9191C5.92544 28.9285 5.90355 28.9394 5.88128 28.9497C5.85805 28.9604 5.83462 28.9703 5.81197 28.9824C5.79142 28.993 5.77203 29.0052 5.75225 29.0167C5.72883 29.0302 5.70541 29.0431 5.68275 29.0579C5.66221 29.0713 5.6432 29.0861 5.62361 29.1005C5.60288 29.1155 5.58176 29.1294 5.56179 29.1456C5.53395 29.1681 5.50784 29.1921 5.48173 29.2163C5.47117 29.2258 5.46003 29.2345 5.44985 29.2444C5.43891 29.2549 5.42989 29.2665 5.41933 29.2772C5.39533 29.3022 5.37113 29.3271 5.34886 29.3536C5.33139 29.3742 5.31603 29.3962 5.2999 29.4177C5.28646 29.4356 5.27206 29.453 5.25939 29.4714C5.24307 29.4952 5.22867 29.5198 5.21408 29.5442C5.20333 29.562 5.192 29.5793 5.18202 29.5974C5.16858 29.6216 5.15744 29.6464 5.14554 29.6712C5.13594 29.6911 5.12595 29.7106 5.11731 29.7306C5.10733 29.7543 5.09907 29.7787 5.09043 29.8027C5.08218 29.8248 5.07354 29.8467 5.06643 29.8693C5.05894 29.8936 5.05338 29.918 5.04723 29.9424C5.04147 29.9657 5.03456 29.9884 5.02995 30.0118C5.02419 30.0402 5.02054 30.0689 5.01651 30.0976C5.01363 30.1174 5.00979 30.1369 5.00768 30.157C5.00269 30.2067 5 30.2566 5 30.3065V39.3097C5 39.7077 5.16183 40.0894 5.44988 40.3708C5.73794 40.6523 6.12862 40.8104 6.536 40.8104C6.94337 40.8104 7.33405 40.6523 7.62211 40.3708C7.91016 40.0894 8.07199 39.7077 8.07199 39.3097V33.929L11.9665 37.734C15.4259 41.1062 20.1132 43 25 43C29.8868 43 34.5741 41.1062 38.0335 37.734C38.3216 37.4525 38.4834 37.0708 38.4834 36.6727C38.4834 36.2747 38.3216 35.8929 38.0335 35.6114C37.7454 35.33 37.3547 35.1719 36.9473 35.1719C36.5398 35.1719 36.1491 35.33 35.861 35.6114V35.6113Z"
            />
          </svg>
        </button>
      </div>
      <div class="flex items-center text-blue-400 text-xs space-x-0.5">
        <svg
          class="w-4 h-4"
          viewBox="0 0 50 50"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M17.0008 23.5707H33.0003C33.354 23.5707 33.6931 23.7212 33.9431 23.9891C34.1932 24.257 34.3336 24.6204 34.3336 24.9993C34.3336 25.3782 34.1932 25.7415 33.9431 26.0094C33.6931 26.2773 33.354 26.4279 33.0003 26.4279H17.0008C16.6472 26.4279 16.3081 26.2773 16.058 26.0094C15.808 25.7415 15.6675 25.3782 15.6675 24.9993C15.6675 24.6204 15.808 24.257 16.058 23.9891C16.3081 23.7212 16.6472 23.5707 17.0008 23.5707ZM20.9995 32.1429H14.3331C12.565 32.1429 10.8694 31.3903 9.61915 30.0508C8.36895 28.7112 7.66659 26.8944 7.66659 25C7.66659 23.1056 8.36895 21.2888 9.61915 19.9492C10.8694 18.6097 12.565 17.8571 14.3331 17.8571H20.9995C21.3531 17.8571 21.6923 17.7066 21.9423 17.4387C22.1924 17.1708 22.3328 16.8075 22.3328 16.4286C22.3328 16.0497 22.1924 15.6863 21.9423 15.4184C21.6923 15.1505 21.3531 15 20.9995 15H14.3331C11.8578 15 9.48388 16.0536 7.73359 17.9289C5.9833 19.8043 5 22.3478 5 25C5 27.6522 5.9833 30.1957 7.73359 32.0711C9.48388 33.9464 11.8578 35 14.3331 35H20.9995C21.3531 35 21.6923 34.8495 21.9423 34.5816C22.1924 34.3137 22.3328 33.9503 22.3328 33.5714C22.3328 33.1925 22.1924 32.8292 21.9423 32.5613C21.6923 32.2934 21.3531 32.1429 20.9995 32.1429ZM35.6669 15H29.0005C28.6469 15 28.3077 15.1505 28.0577 15.4184C27.8076 15.6863 27.6672 16.0497 27.6672 16.4286C27.6672 16.8075 27.8076 17.1708 28.0577 17.4387C28.3077 17.7066 28.6469 17.8571 29.0005 17.8571H35.6669C37.435 17.8571 39.1306 18.6097 40.3808 19.9492C41.6311 21.2888 42.3334 23.1056 42.3334 25C42.3334 26.8944 41.6311 28.7112 40.3808 30.0508C39.1306 31.3903 37.435 32.1429 35.6669 32.1429H29.0005C28.6469 32.1429 28.3077 32.2934 28.0577 32.5613C27.8076 32.8292 27.6672 33.1925 27.6672 33.5714C27.6672 33.9503 27.8076 34.3137 28.0577 34.5816C28.3077 34.8495 28.6469 35 29.0005 35H35.6669C38.1422 35 40.5161 33.9464 42.2664 32.0711C44.0167 30.1957 45 27.6522 45 25C45 22.3478 44.0167 19.8043 42.2664 17.9289C40.5161 16.0536 38.1422 15 35.6669 15Z"
          />
        </svg>
        <a
          :href="`https://gist.github.com/${gistRecord.gistId}`"
          target="_blank"
        >{{ gistRecord.gistId }}</a>
      </div>
    </div>
    <div class="flex-grow">
      <p
        v-if="gistRecord.description"
        class="px-8 text-gray-600 text-base"
      >
        {{ gistRecord.description }}
      </p>
      <div class="px-8 pr-2 flex flex-wrap">
        <div
          v-for="group of gistRecord.groups"
          :key="group"
          class="p-1 mt-2 ml-2 flex items-center text-white bg-green-400 border-2 border-green-400 space-x-1 rounded"
        >
          <svg
            class="w-5 h-5"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M42.6412 15.0387C42.6367 15.0302 42.6333 15.0215 42.6284 15.0131C42.6265 15.0096 42.6239 15.0062 42.6218 15.0027C42.374 14.5747 42.0172 14.221 41.5882 13.9781L26.3576 5.35549C25.9426 5.12238 25.4753 5 25 5C24.5247 5 24.0574 5.12238 23.6424 5.35549L8.41144 13.9781C7.98088 14.2222 7.6231 14.5778 7.37523 15.0081C7.37263 15.0128 7.36935 15.017 7.36658 15.0218C7.3626 15.0293 7.35948 15.0372 7.35533 15.0448C7.12275 15.4609 7.00039 15.9302 7 16.4075V33.5903C7.00036 34.0848 7.13125 34.5703 7.37928 34.9972C7.62731 35.424 7.98358 35.7769 8.41162 36.0196L23.6426 44.6422C24.0262 44.8581 24.4555 44.9788 24.8948 44.9944C24.9263 44.9969 24.9576 44.9997 24.9896 45H25.0021C25.0457 45 25.0888 44.9976 25.1314 44.9936C25.5617 44.9743 25.9817 44.854 26.3576 44.6422L41.5884 36.0196C42.0165 35.7769 42.3728 35.424 42.6209 34.9971C42.8689 34.5701 42.9998 34.0845 43 33.59V16.4075C42.9996 15.9278 42.876 15.4564 42.6412 15.0389V15.0387ZM25 7.78479L38.8017 15.5984L33.5021 18.6287L19.5377 10.8771L25 7.78479ZM25.1575 23.3998L11.2194 15.5864L16.6991 12.4842L30.6774 20.2436L25.1575 23.3998ZM26.4057 41.417L26.5418 25.8138L32.1 22.6358V29.2684C32.1 29.638 32.2458 29.9925 32.5055 30.2538C32.7652 30.5151 33.1174 30.662 33.4846 30.662C33.8518 30.662 34.204 30.5151 34.4636 30.2538C34.7233 29.9925 34.8692 29.638 34.8692 29.2684V21.0524L40.2308 17.9868V33.5902L26.4057 41.417Z"
            />
          </svg>
          <span class="text-xs">{{ group }}</span>
        </div>
      </div>
    </div>

    <div class="px-8 py-4 flex justify-between items-center bg-gray-100 space-x-4 rounded-b">
      <p class="text-xs text-gray-400">
        最近更新时间 {{ updateTimeString }}
      </p>
      <div class="flex items-center space-x-2">
        <button
          title="edit gist record"
          class="p-1 text-gray-400 hover:bg-gray-200 rounded"
          :class="{
            'opacity-10': !token
          }"
          :disabled="!token"
          @click="$emit('edit-gist-record')"
        >
          <svg
            class="w-5 h-5"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M43.0724 14.79L34.2112 5.92926C33.9166 5.63465 33.5669 5.40095 33.1819 5.24151C32.797 5.08206 32.3845 5 31.9678 5C31.5512 5 31.1386 5.08206 30.7537 5.24151C30.3688 5.40095 30.019 5.63465 29.7244 5.92926L24.501 11.1525V11.1527L24.5006 11.1529L5.92941 29.7235C5.63386 30.0173 5.39953 30.3669 5.24 30.752C5.08047 31.137 4.9989 31.5499 5.00001 31.9667V40.8274C5.00096 41.6686 5.33552 42.475 5.93032 43.0697C6.52511 43.6645 7.33155 43.9991 8.17271 44H17.6908C17.8991 44 18.1054 43.959 18.2979 43.8793C18.4903 43.7996 18.6652 43.6827 18.8125 43.5354L43.0724 19.2764C43.6664 18.681 44 17.8743 44 17.0332C44 16.1922 43.6664 15.3854 43.0724 14.79ZM17.0338 40.8274H8.17271V31.9667L25.6225 14.5176L34.4837 23.3783L17.0338 40.8274ZM36.727 21.1351L27.866 12.2744L31.9679 8.17246L40.8291 17.0332L36.727 21.1351Z"
            />
          </svg>
        </button>
        <button
          title="delete gist record"
          class="p-1 text-red-400 hover:text-white hover:bg-red-400 rounded"
          @click="$emit('delete-gist-record')"
        >
          <svg
            class="w-5 h-5"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M41.5 11H34.0007V9.5C33.9994 8.30694 33.5249 7.16312 32.6813 6.3195C31.8376 5.47588 30.6938 5.00134 29.5007 5H20.5007C19.3077 5.00134 18.1639 5.47588 17.3202 6.3195C16.4766 7.16312 16.0021 8.30694 16.0007 9.5V11H8.5C8.10217 11 7.72064 11.158 7.43934 11.4393C7.15804 11.7206 7 12.1022 7 12.5C7 12.8978 7.15804 13.2794 7.43934 13.5607C7.72064 13.842 8.10217 14 8.5 14H10V41C10.0009 41.7954 10.3173 42.5579 10.8797 43.1203C11.4421 43.6827 12.2046 43.9991 13 44H37C37.7954 43.9991 38.5579 43.6827 39.1203 43.1203C39.6827 42.5579 39.9991 41.7954 40 41V14H41.5C41.8978 14 42.2794 13.842 42.5607 13.5607C42.842 13.2794 43 12.8978 43 12.5C43 12.1022 42.842 11.7206 42.5607 11.4393C42.2794 11.158 41.8978 11 41.5 11ZM19.0007 9.5C19.0012 9.10233 19.1594 8.72109 19.4406 8.43989C19.7218 8.15869 20.1031 8.0005 20.5007 8H29.5007C29.8984 8.0005 30.2797 8.15869 30.5609 8.43989C30.8421 8.72109 31.0003 9.10233 31.0007 9.5V11H19.0007V9.5ZM37 41H13V14H37V41ZM22.0007 21.5V33.5C22.0007 33.8978 21.8427 34.2794 21.5614 34.5607C21.2801 34.842 20.8986 35 20.5007 35C20.1029 35 19.7214 34.842 19.4401 34.5607C19.1588 34.2794 19.0007 33.8978 19.0007 33.5V21.5C19.0007 21.1022 19.1588 20.7206 19.4401 20.4393C19.7214 20.158 20.1029 20 20.5007 20C20.8986 20 21.2801 20.158 21.5614 20.4393C21.8427 20.7206 22.0007 21.1022 22.0007 21.5ZM31.0007 21.5V33.5C31.0007 33.8978 30.8427 34.2794 30.5614 34.5607C30.2801 34.842 29.8986 35 29.5007 35C29.1029 35 28.7214 34.842 28.4401 34.5607C28.1588 34.2794 28.0007 33.8978 28.0007 33.5V21.5C28.0007 21.1022 28.1588 20.7206 28.4401 20.4393C28.7214 20.158 29.1029 20 29.5007 20C29.8986 20 30.2801 20.158 30.5614 20.4393C30.8427 20.7206 31.0007 21.1022 31.0007 21.5Z"
            />
          </svg>
        </button>
      </div>
    </div>
  </div>
</template>
<script>
import {
  ref, computed, onMounted, watch,
} from 'vue';
import useGist from '@/composables/useGist';

export default {
  props: {
    gistRecord: {
      type: Object,
      default() {
        return {};
      },
    },
    token: {
      type: String,
      default: '',
    },
    syncGistId: {
      type: String,
      default: '',
    },
  },
  emits: ['edit-gist-record', 'delete-gist-record', 'sync-gist', 'reset-sync-gist'],
  setup(props, context) {
    const { getGist } = useGist();

    const updateTime = ref('');
    const updateTimeString = computed(() => {
      if (!updateTime.value) {
        return '无记录';
      }
      const date = new Date(updateTime.value);
      return date.toLocaleString();
    });

    const refreshUpdateTime = async () => {
      const gist = await getGist(props.token, props.gistRecord.gistId);
      if (gist) {
        const lastCommit = gist.history[0];
        updateTime.value = lastCommit.committed_at;
      }
    };

    onMounted(() => {
      refreshUpdateTime();
    });

    // sync gist
    const syncGistState = ref(false);
    const syncGistHandler = () => {
      context.emit('sync-gist');
      syncGistState.value = true;
    };

    watch(() => props.syncGistId, async (newValue, oldValue) => {
      // console.log(props.syncGistId);
      if (props.syncGistId === 'all' || props.syncGistId === props.gistRecord.gistId) {
        await refreshUpdateTime();
        context.emit('reset-sync-gist');
      }
      syncGistState.value = false;
    });

    return {
      updateTimeString,
      syncGistState,
      syncGistHandler,
    };
  },
};
</script>
<style lang="scss" scoped>
</style>
