<template>
  <div class="min-w-max p-1 absolute top-0 right-0 bg-white rounded shadow">
    <button
      :title="webDAVTitle"
      class="btn"
      :class="{
        'opacity50': webDAVString === '正在同步中'
      }"
      :disabled="webDAVString === '正在同步中'"
      @click="syncWebDAVHandler"
    >
      <div
        :class="{
          'text-green-400': webDAVState === '连接成功',
          'text-red-400': webDAVState !== '连接成功'
        }"
      >
        <svg
          v-show="webDAVState === '连接成功'"
          class="w-5 h-5 flex-shrink-0"
          viewBox="0 0 50 50"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M44.9999 24.5C45.009 27.6394 44.0045 30.6955 42.1397 33.2016C42.0377 33.3414 41.9094 33.4593 41.7622 33.5486C41.6151 33.6378 41.4519 33.6967 41.2822 33.7217C41.1126 33.7468 40.9397 33.7376 40.7735 33.6946C40.6073 33.6516 40.4512 33.5757 40.3141 33.4712C40.177 33.3668 40.0616 33.2359 39.9746 33.086C39.8877 32.9362 39.8308 32.7703 39.8072 32.5981C39.7837 32.4258 39.794 32.2506 39.8376 32.0824C39.8812 31.9142 39.9571 31.7564 40.0611 31.6182C41.1733 30.1142 41.9172 28.3638 42.2314 26.5112C42.5456 24.6586 42.4212 22.7567 41.8684 20.9624C41.3156 19.1681 40.3502 17.5327 39.0518 16.1909C37.7534 14.8492 36.1592 13.8395 34.4004 13.2451C32.6417 12.6506 30.7689 12.4885 28.9363 12.772C27.1036 13.0555 25.3637 13.7765 23.8598 14.8757C22.3558 15.9748 21.131 17.4206 20.2862 19.0939C19.4415 20.7672 19.0009 22.6201 19.0008 24.5C19.0008 24.8496 18.8639 25.1848 18.6201 25.4321C18.3763 25.6793 18.0457 25.8181 17.7009 25.8181C17.3561 25.8181 17.0255 25.6793 16.7817 25.4321C16.5379 25.1848 16.4009 24.8496 16.4009 24.5C16.4001 23.1696 16.5802 21.8456 16.9362 20.5652C16.758 20.5525 16.5795 20.5459 16.4009 20.5454C14.3323 20.5454 12.3484 21.3787 10.8857 22.8619C9.42295 24.3452 8.60119 26.3569 8.60119 28.4545C8.60119 30.5521 9.42295 32.5639 10.8857 34.0471C12.3484 35.5303 14.3323 36.3636 16.4009 36.3636H20.3008C20.6456 36.3636 20.9762 36.5025 21.22 36.7497C21.4638 36.9969 21.6007 37.3322 21.6007 37.6818C21.6007 38.0314 21.4638 38.3667 21.22 38.6139C20.9762 38.8611 20.6456 39 20.3008 39H16.4009C14.9714 39.0002 13.5571 38.7015 12.2465 38.1226C10.9358 37.5437 9.757 36.6969 8.78355 35.6353C7.8101 34.5737 7.06296 33.32 6.58877 31.9524C6.11458 30.5849 5.92354 29.1329 6.02757 27.6871C6.13161 26.2413 6.52848 24.8328 7.19341 23.5496C7.85834 22.2663 8.77704 21.1358 9.89215 20.2287C11.0073 19.3216 12.2948 18.6574 13.6744 18.2775C15.0541 17.8977 16.4961 17.8103 17.9105 18.0209C19.3498 15.0983 21.7204 12.7542 24.6378 11.3687C27.5553 9.98311 30.8488 9.63728 33.9844 10.3872C37.1199 11.1372 39.9138 12.9389 41.9132 15.5005C43.9126 18.062 45.0003 21.2332 44.9999 24.5ZM30.3202 23.5687C30.2897 23.5376 30.2576 23.5081 30.2242 23.4803C30.2105 23.469 30.1962 23.4593 30.1822 23.4485C30.1623 23.4334 30.1426 23.4177 30.122 23.4036C30.1044 23.3917 30.0864 23.3816 30.0685 23.3706C30.05 23.3594 30.0319 23.3477 30.0128 23.3373C29.9944 23.3274 29.9754 23.3189 29.9565 23.31C29.937 23.3004 29.9175 23.2905 29.8976 23.282C29.8794 23.2745 29.8608 23.2683 29.8423 23.2617C29.8209 23.2536 29.7994 23.2452 29.7773 23.2386C29.7591 23.233 29.7404 23.2289 29.7221 23.2241C29.6993 23.2184 29.677 23.2119 29.6541 23.2073C29.633 23.203 29.6117 23.2007 29.5904 23.1974C29.5698 23.1945 29.5493 23.1905 29.5284 23.1884C29.4907 23.1848 29.4528 23.1828 29.4149 23.1826C29.4101 23.1826 29.4052 23.1818 29.4005 23.1818C29.3958 23.1818 29.3909 23.1826 29.386 23.1826C29.3481 23.1828 29.3103 23.1848 29.2726 23.1884C29.2516 23.1905 29.2313 23.1945 29.2105 23.1974C29.1894 23.2007 29.1679 23.203 29.1468 23.2073C29.1239 23.2119 29.1015 23.2184 29.0791 23.2241C29.0605 23.2289 29.0419 23.233 29.0237 23.2386C29.0016 23.2452 28.9801 23.2536 28.9587 23.2617C28.9401 23.2683 28.9216 23.2745 28.9034 23.2821C28.8833 23.2905 28.8639 23.3004 28.8444 23.31C28.8256 23.3189 28.8066 23.3274 28.7882 23.3373C28.769 23.3477 28.7508 23.3594 28.7325 23.3708C28.7146 23.3816 28.6966 23.3917 28.6792 23.4036C28.6584 23.4177 28.6387 23.4332 28.6187 23.4485C28.6049 23.4593 28.5904 23.469 28.5768 23.4803C28.5433 23.5081 28.5112 23.5376 28.4806 23.5687L22.966 29.1606C22.8441 29.2827 22.7472 29.4281 22.6809 29.5883C22.6146 29.7486 22.5802 29.9205 22.5797 30.0943C22.5792 30.2681 22.6126 30.4403 22.6779 30.6009C22.7433 30.7616 22.8393 30.9075 22.9605 31.0304C23.0817 31.1533 23.2256 31.2506 23.3841 31.3169C23.5425 31.3832 23.7123 31.417 23.8837 31.4164C24.0551 31.4159 24.2246 31.381 24.3827 31.3138C24.5407 31.2465 24.684 31.1483 24.8045 31.0246L28.1005 27.6824V37.6818C28.1005 38.0314 28.2375 38.3667 28.4813 38.6139C28.7251 38.8611 29.0557 39 29.4005 39C29.7452 39 30.0759 38.8611 30.3197 38.6139C30.5635 38.3667 30.7004 38.0314 30.7004 37.6818V27.6824L33.9965 31.0246C34.1169 31.1483 34.2603 31.2465 34.4183 31.3138C34.5763 31.381 34.7459 31.4159 34.9173 31.4164C35.0887 31.417 35.2584 31.3832 35.4169 31.3169C35.5753 31.2506 35.7193 31.1533 35.8404 31.0304C35.9616 30.9075 36.0577 30.7616 36.123 30.6009C36.1884 30.4403 36.2217 30.2681 36.2212 30.0943C36.2207 29.9205 36.1863 29.7486 36.12 29.5883C36.0537 29.4281 35.9568 29.2827 35.8349 29.1606L30.3202 23.5687Z"
          />
        </svg>
        <svg
          v-show="webDAVState !== '连接成功'"
          class="w-5 h-5 flex-shrink-0"
          viewBox="0 0 50 50"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M36.97 35.495L36.965 35.4898L19.8372 17.8327L19.8289 17.8239L12.6531 10.4262C12.5364 10.3013 12.3942 10.1994 12.235 10.1266C12.0758 10.0538 11.9027 10.0114 11.7259 10.002C11.549 9.99259 11.3719 10.0163 11.2049 10.0718C11.0379 10.1272 10.8844 10.2133 10.7533 10.325C10.6222 10.4367 10.5162 10.5717 10.4415 10.7222C10.3667 10.8728 10.3247 11.0357 10.3179 11.2017C10.3111 11.3676 10.3396 11.5331 10.4018 11.6885C10.4641 11.844 10.5587 11.9863 10.6803 12.1071L17.2206 18.8499L17.2106 18.8697C15.76 18.6708 14.2813 18.7543 12.8668 19.115C11.4522 19.4756 10.1321 20.1057 8.98894 20.9658C7.84578 21.8259 6.90406 22.8977 6.22258 24.1142C5.5411 25.3306 5.13449 26.6657 5.02812 28.036C4.92175 29.4064 5.11791 30.7825 5.60435 32.0786C6.0908 33.3747 6.85709 34.5629 7.85539 35.5691C8.85368 36.5752 10.0626 37.3777 11.4065 37.9265C12.7505 38.4752 14.2008 38.7584 15.6668 38.7584H30.3334C32.1461 38.7618 33.9436 38.4478 35.6332 37.8324L37.3469 39.5991C37.5856 39.8409 37.9167 39.9846 38.268 39.9988C38.6193 40.0131 38.9623 39.8967 39.2225 39.675C39.4826 39.4533 39.6388 39.1443 39.657 38.8152C39.6753 38.4861 39.5541 38.1636 39.3199 37.9179L36.97 35.495ZM30.3334 36.2591H15.6668C13.545 36.2591 11.5102 35.4692 10.0099 34.0631C8.50964 32.657 7.66679 30.7499 7.66679 28.7614C7.66679 26.7729 8.50964 24.8658 10.0099 23.4597C11.5102 22.0536 13.545 21.2637 15.6668 21.2637C15.8508 21.2637 16.0341 21.2707 16.2169 21.2824C15.8523 22.4963 15.6672 23.7514 15.6668 25.0125C15.6668 25.344 15.8072 25.6618 16.0573 25.8962C16.3073 26.1305 16.6465 26.2622 17.0001 26.2622C17.3537 26.2622 17.6928 26.1305 17.9429 25.8962C18.1929 25.6618 18.3334 25.344 18.3334 25.0125C18.3335 23.5933 18.6198 22.1868 19.1773 20.8672L33.6772 35.8158C32.5906 36.111 31.4647 36.2603 30.3334 36.2591V36.2591ZM45 25.0125C45.0023 28.3897 43.6758 31.6491 41.2743 34.167C41.0387 34.4141 40.708 34.5634 40.355 34.5821C40.0019 34.6007 39.6554 34.4871 39.3917 34.2663C39.128 34.0455 38.9687 33.7355 38.9488 33.4046C38.9289 33.0737 39.0501 32.749 39.2857 32.5018C41.2606 30.4276 42.3459 27.7415 42.3322 24.9615C42.3185 22.1816 41.2068 19.5049 39.2116 17.4479C37.2164 15.3908 34.4791 14.0992 31.5277 13.8221C28.5762 13.5451 25.6199 14.3023 23.2291 15.9476C22.9441 16.1403 22.5894 16.2197 22.2423 16.1686C21.8951 16.1175 21.5836 15.94 21.3753 15.6747C21.167 15.4095 21.0789 15.0779 21.13 14.7521C21.1812 14.4262 21.3676 14.1325 21.6486 13.9348C23.8338 12.4303 26.4213 11.523 29.1235 11.3136C31.8258 11.1042 34.5371 11.6009 36.9564 12.7485C39.3756 13.8962 41.408 15.6499 42.828 17.8148C44.2479 19.9798 44.9998 22.4713 45 25.0125V25.0125Z"
          />
        </svg>
      </div>
      <span class="flex-shrink-0 text-sm">{{ webDAVString }}</span>
    </button>
    <button
      title="show extension options page"
      class="btn"
      :class="{
        'opacity50': gistString === '正在同步中'
      }"
      :disabled="gistString === '正在同步中'"
      @click="syncGistHandler"
    >
      <svg
        class="w-5 h-5 flex-shrink-0"
        viewBox="0 0 50 50"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M24.8735 6C13.8934 6 5 14.8934 5 25.8735C5 34.6676 10.6888 42.0953 18.5885 44.7285C19.5822 44.9024 19.9548 44.3062 19.9548 43.7845C19.9548 43.3126 19.93 41.7475 19.93 40.0831C14.9368 41.0023 13.645 38.8658 13.2475 37.748C13.0239 37.1766 12.0551 35.4128 11.2105 34.9408C10.5149 34.5682 9.52123 33.649 11.1856 33.6242C12.7507 33.5994 13.8686 35.065 14.2412 35.6612C16.0298 38.6671 18.8866 37.8225 20.0294 37.3008C20.2032 36.009 20.7249 35.1396 21.2963 34.6427C16.8744 34.1459 12.2538 32.4318 12.2538 24.8302C12.2538 22.6689 13.0239 20.8803 14.2909 19.4892C14.0921 18.9923 13.3966 16.9553 14.4896 14.2227C14.4896 14.2227 16.154 13.701 19.9548 16.2597C21.5447 15.8126 23.234 15.589 24.9232 15.589C26.6125 15.589 28.3017 15.8126 29.8916 16.2597C33.6924 13.6762 35.3568 14.2227 35.3568 14.2227C36.4499 16.9553 35.7543 18.9923 35.5556 19.4892C36.8225 20.8803 37.5926 22.6441 37.5926 24.8302C37.5926 32.4566 32.9472 34.1459 28.5253 34.6427C29.2457 35.2638 29.8668 36.4562 29.8668 38.3193C29.8668 40.9774 29.8419 43.1138 29.8419 43.7845C29.8419 44.3062 30.2145 44.9273 31.2082 44.7285C35.1534 43.3966 38.5816 40.861 41.0103 37.4786C43.439 34.0963 44.7459 30.0375 44.7471 25.8735C44.7471 14.8934 35.8537 6 24.8735 6Z"
        />
      </svg>
      <span class="flex-shrink-0 text-sm">{{ gistString }}</span>
    </button>
    <button
      title="show extension options page"
      class="btn"
      @click="showOptionsPageHandler"
    >
      <svg
        class="w-5 h-5 flex-shrink-0"
        viewBox="0 0 50 50"
        fill="currentColor"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M24.9999 14.6684C22.9565 14.6684 20.959 15.2743 19.26 16.4095C17.561 17.5448 16.2367 19.1584 15.4548 21.0462C14.6728 22.934 14.4682 25.0114 14.8668 27.0155C15.2655 29.0196 16.2495 30.8605 17.6944 32.3054C19.1393 33.7503 20.9802 34.7343 22.9843 35.133C24.9884 35.5316 27.0658 35.327 28.9536 34.545C30.8415 33.7631 32.4551 32.4388 33.5903 30.7398C34.7256 29.0408 35.3315 27.0433 35.3315 24.9999C35.3284 22.2608 34.2389 19.6347 32.302 17.6979C30.3651 15.761 27.7391 14.6715 24.9999 14.6684ZM24.9999 32.3796C23.5403 32.3796 22.1136 31.9468 20.9 31.1359C19.6864 30.325 18.7405 29.1725 18.182 27.824C17.6234 26.4755 17.4773 24.9917 17.762 23.5602C18.0468 22.1287 18.7496 20.8138 19.7817 19.7817C20.8137 18.7496 22.1287 18.0468 23.5602 17.762C24.9917 17.4773 26.4755 17.6234 27.824 18.182C29.1725 18.7405 30.325 19.6864 31.1359 20.9C31.9468 22.1136 32.3796 23.5404 32.3796 24.9999C32.3774 26.9565 31.5992 28.8322 30.2157 30.2157C28.8322 31.5992 26.9565 32.3774 24.9999 32.3796ZM44.7048 29.1336L41.9599 25.4742C41.964 25.1508 41.9607 24.806 41.9559 24.5308L44.7035 20.8675C44.838 20.6882 44.9299 20.4806 44.9722 20.2605C45.0145 20.0405 45.0062 19.8136 44.9478 19.5973C44.4871 17.8899 43.8081 16.2492 42.9276 14.7156C42.8159 14.5211 42.6614 14.3547 42.4757 14.2289C42.2901 14.1031 42.0782 14.0213 41.8562 13.9896L37.3386 13.3444C37.1174 13.1104 36.8897 12.8826 36.6554 12.6611L36.0104 8.14546C35.9788 7.92358 35.897 7.71183 35.7713 7.52627C35.6456 7.34071 35.4793 7.1862 35.285 7.07449C33.7519 6.193 32.1115 5.51295 30.4044 5.05116C30.188 4.99263 29.9611 4.9842 29.7409 5.02649C29.5207 5.06878 29.313 5.16069 29.1336 5.29524L25.4829 8.03366C25.1609 8.02465 24.8387 8.02465 24.5167 8.03366L20.8673 5.29654C20.688 5.1621 20.4804 5.07024 20.2603 5.02792C20.0403 4.9856 19.8134 4.99393 19.597 5.05227C17.8897 5.51296 16.249 6.19196 14.7154 7.07246C14.5209 7.18413 14.3544 7.33865 14.2286 7.52429C14.1028 7.70992 14.0209 7.92179 13.9892 8.1438L13.3442 12.6615C13.1103 12.8826 12.8825 13.1104 12.6609 13.3448L8.14541 13.9894C7.92354 14.0211 7.71178 14.1029 7.52622 14.2286C7.34066 14.3543 7.18616 14.5206 7.07444 14.7149C6.19291 16.248 5.51286 17.8884 5.05111 19.5956C4.99262 19.812 4.98421 20.0389 5.0265 20.2591C5.06879 20.4792 5.16068 20.6868 5.29519 20.8662L8.04007 24.5256C8.03601 24.849 8.03933 25.1938 8.04413 25.4691L5.29648 29.1325C5.162 29.3118 5.07011 29.5194 5.02778 29.7395C4.98546 29.9596 4.99382 30.1864 5.05221 30.4028C5.51287 32.1101 6.19188 33.7509 7.07241 35.2844C7.1841 35.4789 7.33863 35.6453 7.52427 35.7711C7.7099 35.8969 7.92176 35.9787 8.14375 36.0104L12.6614 36.6556C12.8826 36.8896 13.1103 37.1174 13.3446 37.3389L13.9896 41.8546C14.0212 42.0764 14.103 42.2882 14.2287 42.4737C14.3544 42.6593 14.5207 42.8138 14.715 42.9255C16.2481 43.807 17.8885 44.4871 19.5956 44.9489C19.812 45.0074 20.0389 45.0158 20.2591 44.9735C20.4793 44.9312 20.687 44.8393 20.8664 44.7048L24.5171 41.9664C24.8391 41.9754 25.1613 41.9754 25.4833 41.9664L29.1325 44.7037C29.3118 44.8382 29.5194 44.9301 29.7395 44.9724C29.9596 45.0148 30.1864 45.0064 30.4028 44.9479C32.1101 44.4872 33.7509 43.8082 35.2844 42.9277C35.4789 42.8161 35.6454 42.6615 35.7712 42.4759C35.897 42.2903 35.9789 42.0784 36.0106 41.8564L36.6571 37.328C36.8817 37.1079 37.1032 36.8845 37.3214 36.658L41.8546 36.0104C42.0764 35.9788 42.2882 35.897 42.4738 35.7713C42.6593 35.6457 42.8138 35.4794 42.9256 35.2852C43.8071 33.752 44.4871 32.1116 44.9489 30.4044C45.0074 30.188 45.0158 29.9611 44.9735 29.741C44.9312 29.5208 44.8393 29.3132 44.7048 29.1338V29.1336ZM40.707 33.1925L36.3982 33.8079C36.0669 33.8552 35.7614 34.0138 35.532 34.2575C35.304 34.5 34.6363 35.1959 34.2908 35.5018C34.0286 35.7339 33.8575 36.0517 33.8081 36.3984L33.1927 40.7083C32.2701 41.1896 31.3066 41.5882 30.3137 41.8994L26.8319 39.2879C26.5518 39.0779 26.2063 38.9743 25.8569 38.9955C25.2863 39.0301 24.7141 39.0301 24.1435 38.9955C23.7941 38.9746 23.4487 39.0782 23.1685 39.2879L19.6856 41.9005C18.6929 41.5885 17.7297 41.1891 16.8075 40.707L16.1922 36.3984C16.1427 36.0518 15.9716 35.7342 15.7094 35.5021C15.2816 35.1231 14.8771 34.7186 14.498 34.2907C14.266 34.0287 13.9483 33.8576 13.6018 33.8081L9.29167 33.1927C8.81032 32.2701 8.41167 31.3066 8.1004 30.3137L10.7121 26.8317C10.9129 26.5639 11.0168 26.2358 11.0067 25.9012C10.9966 25.5685 10.9765 24.6044 11.0045 24.1437C11.0257 23.7942 10.9221 23.4486 10.7121 23.1685L8.09948 19.6856C8.41147 18.6929 8.81086 17.7298 9.29296 16.8075L13.6014 16.1923C13.9481 16.1428 14.2659 15.9717 14.498 15.7094C14.877 15.2817 15.2814 14.8772 15.7092 14.4983C15.9714 14.2661 16.1425 13.9483 16.1919 13.6016L16.8073 9.29171C17.73 8.81035 18.6935 8.41171 19.6865 8.10045L23.1683 10.7121C23.4484 10.922 23.7939 11.0256 24.1433 11.0045C24.7139 10.9699 25.2861 10.9699 25.8567 11.0045C26.2061 11.026 26.5518 10.9223 26.8317 10.7121L30.3146 8.09952C31.3073 8.41152 32.2705 8.81091 33.1927 9.293L33.8079 13.6016C33.8575 13.9482 34.0286 14.2659 34.2908 14.4979C34.7186 14.8769 35.1231 15.2814 35.5021 15.7093C35.7342 15.9714 36.0519 16.1424 36.3984 16.1919L40.7087 16.8074C41.1898 17.7301 41.5883 18.6936 41.8994 19.6865L39.2877 23.1685C39.0868 23.4363 38.9829 23.7644 38.9931 24.099C39.0033 24.4313 39.0234 25.3947 38.9953 25.8565C38.974 26.206 39.0778 26.5517 39.2879 26.8317L41.9003 30.3146C41.5883 31.3073 41.1889 32.2704 40.7069 33.1927L40.707 33.1925Z"
        />
      </svg>
      <span class="flex-shrink-0 text-sm">更多设置</span>
    </button>
  </div>
  <transition name="dissolve">
    <div
      v-if="showMsg && msg"
      class="fixed top-4 right-4 z-10 p-4 text-white rounded shadow"
      :class="{
        'bg-green-400': msg.state === true,
        'bg-red-400': msg.state === false
      }"
    >
      {{ msg.title }}
    </div>
  </transition>
</template>
<script>
import {
  ref, computed, onMounted, inject,
} from 'vue';
import useGist from '@/composables/useGist';

export default {
  setup(props) {
    const db = inject('db');

    const {
      setGithubToken, getGithubToken, clearGithubToken, getGistsRecord, setGistsRecord, clearGistsRecord, createGist, updateGist, getGist,
    } = useGist();

    /**
     * popup msg
     */
    const showMsg = ref(false);
    const msg = ref(null);

    const setMsg = (state, title, duration = 1000) => {
      msg.value = {
        state,
        title,
      };
      showMsg.value = true;
      let timer = setTimeout(() => {
        showMsg.value = false;
        msg.value = null;
        timer = null;
      }, duration);
    };

    const webDAVState = inject('webDAVState');

    const lastFileState = inject('lastFileState');

    const webDAVString = ref('WebDAV 同步');
    const webDAVBakcupTime = ref(null);
    const webDAVTitle = computed(() => {
      if (!webDAVBakcupTime.value) return '无记录';
      const date = new Date(webDAVBakcupTime.value);
      return `最后一次同步时间 ${date.toLocaleString()}`;
    });

    onMounted(() => {
      if (webDAVState.value === '未添加') {
        webDAVString.value = '设置 WebDAV';
        webDAVBakcupTime.value = null;
      } else if (webDAVState.value === '连接成功') {
        webDAVString.value = 'WebDAV 同步';
        if (lastFileState.value) webDAVBakcupTime.value = lastFileState.value.lastmod;
      } else {
        webDAVString.value = '检查 WebDAV';
        webDAVBakcupTime.value = null;
      }
    });

    const syncWebDAV = inject('syncWebDAV');

    const syncWebDAVHandler = async () => {
      if (webDAVState.value === '连接成功') {
        webDAVString.value = '正在同步中';
        await syncWebDAV();
        webDAVString.value = 'WebDAV 同步';
      } else {
        chrome.runtime.openOptionsPage();
      }
    };

    // sync Gist
    const token = ref('');
    const gistsRecords = ref([]);

    const gistString = ref('');
    onMounted(async () => {
      token.value = await getGithubToken();
      gistsRecords.value = await getGistsRecord();

      if (token.value) {
        gistString.value = 'Gist 同步';
      } else {
        gistString.value = '设置 Gist';
      }
    });

    const getBookmarksByGroup = (group, shareableIds = []) => new Promise((resolve, reject) => {
      db.bookmark.where('groups').equals(group).filter((item) => shareableIds.includes(item.id)).toArray()
        .then((result) => {
          resolve({
            group,
            bookmarks: result,
          });
        });
    });

    const getAllGroupsContent = async (groups) => {
      const shareableIds = await db.share.where('share').equals(1).primaryKeys();
      const promiseArr = [];
      groups.forEach((group) => {
        promiseArr.push(getBookmarksByGroup(group, shareableIds));
      });
      const allGroups = await Promise.all(promiseArr);
      return allGroups;
    };

    const syncGistHandler = async () => {
      if (token.value) {
        gistString.value = '正在同步中';
        const allGroupsArr = [];
        gistsRecords.value.forEach((gistRecord) => {
          allGroupsArr.push(...gistRecord.groups);
        });
        const allGroups = [...new Set(allGroupsArr)];
        const allGroupsContent = await getAllGroupsContent(allGroups);

        const updatePromiseArr = [];
        gistsRecords.value.forEach((gistRecord) => {
          const fileContent = [];
          gistRecord.groups.forEach((group) => {
            const targetGroup = allGroupsContent.find((item) => item.group === group);
            fileContent.push(targetGroup);
          });
          const updatePromise = updateGist(token.value, gistRecord.gistId, {
            gist_id: gistRecord.gistId,
            description: gistRecord.description,
            files: { [`${gistRecord.filename}.json`]: { content: JSON.stringify(fileContent) } },
          });
          updatePromiseArr.push(updatePromise);
        });
        Promise.all(updatePromiseArr).then(() => {
          setMsg(true, '更新成功');
          gistString.value = 'Gist 同步';
        }).catch((err) => {
          gistString.value = 'Gist 同步';
          console.log('Error', err);
        });
      } else {
        chrome.runtime.openOptionsPage();
      }
    };

    // show extension options page
    const showOptionsPageHandler = () => {
      chrome.runtime.openOptionsPage();
    };

    return {
      showMsg,
      msg,
      webDAVString,
      webDAVTitle,
      webDAVState,
      gistString,
      syncWebDAVHandler,
      syncGistHandler,
      showOptionsPageHandler,
    };
  },
};
</script>
<style lang="scss" scoped>
.btn {
  @apply w-full p-2 flex items-center text-gray-600 hover:bg-gray-200 space-x-0.5 rounded;
}
</style>
