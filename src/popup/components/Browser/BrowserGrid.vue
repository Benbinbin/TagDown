<template>
  <div
    class="w-full px-8 py-4 grid grid-flow-row-dense grid-cols-4 gap-x-2 gap-y-1"
  >
    <div
      v-for="node of nodes"
      :key="node.id"
      class="grid-item space-y-1 rounded"
      :class="{
        'bg-gray-100': unfoldFolders.has(node.id),
        'row-span-2': unfoldFolders.has(node.id) && node.children.length === 1,
        'row-span-3': unfoldFolders.has(node.id) && node.children.length === 2,
        'row-span-4': unfoldFolders.has(node.id) && node.children.length === 3,
        'row-span-5': unfoldFolders.has(node.id) && node.children.length >=4,
      }"
    >
      <div class="p-1 flex items-start">
        <!-- folder node -->
        <button
          v-if="node.children"
          class="flex-grow p-0.5 flex items-start hover:bg-gray-200 space-x-0.5 rounded-sm"
          @click.shift.exact="toggleFolderState(node)"
          @click.exact="$emit('open-folder', node.id)"
        >
          <svg
            v-if="node.children.length > 0 && !unfoldFolders.has(node.id)"
            class="flex-shrink-0 w-4 h-4"
            viewBox="0 0 50 50"
            fill="#FBBF24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M41 14H25.1212L20 8.87901C19.7222 8.5995 19.3916 8.37788 19.0276 8.227C18.6635 8.07612 18.2731 7.99896 17.879 8.00001H8C7.20459 8.0008 6.44199 8.31713 5.87956 8.87957C5.31712 9.442 5.00079 10.2046 5 11V38.1157C5.00104 38.8806 5.30544 39.6138 5.84641 40.1545C6.38738 40.6952 7.12075 40.9993 7.88562 41H41.1669C41.918 40.999 42.638 40.7002 43.1691 40.1691C43.7002 39.638 43.999 38.918 44 38.1669V17.0002C43.9992 16.2048 43.6829 15.4422 43.1204 14.8798C42.558 14.3173 41.7954 14.001 41 14.0002V14ZM8 11H17.879L20.879 14H8V11Z"
            />
          </svg>

          <svg
            v-if="node.children.length > 0 && unfoldFolders.has(node.id)"
            class="flex-shrink-0 w-4 h-4"
            viewBox="0 0 50 50"
            fill="#FBBF24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M43.4674 21.1866C43.2053 20.8197 42.861 20.5209 42.4626 20.3147C42.0643 20.1084 41.6233 20.0006 41.1758 20H38.8982V17.1429C38.8974 16.3854 38.5995 15.6591 38.0699 15.1235C37.5403 14.5879 36.8223 14.2866 36.0734 14.2857H23.8324L18.9361 10.5714C18.4464 10.2017 17.852 10.0013 17.241 10H7.82485C7.07591 10.0009 6.35789 10.3021 5.82831 10.8378C5.29873 11.3734 5.00084 12.0996 5 12.8571V38.5714C5 38.5805 5.00124 38.5893 5.00141 38.5984C5.00177 38.6186 5.00318 38.6384 5.00424 38.6586C5.00636 38.6925 5.00936 38.7263 5.01359 38.7596C5.01595 38.7777 5.01871 38.7958 5.02189 38.8137C5.02807 38.8504 5.03566 38.8863 5.04449 38.9218C5.0482 38.9366 5.05155 38.9514 5.05579 38.9661C5.06797 39.0088 5.0821 39.0504 5.09781 39.0912C5.10081 39.0987 5.10311 39.1066 5.10611 39.1141C5.12628 39.164 5.14927 39.2126 5.17496 39.2598C5.17779 39.265 5.18114 39.2698 5.18397 39.2748C5.20657 39.3153 5.23105 39.3543 5.25741 39.392C5.26077 39.3968 5.26324 39.402 5.2666 39.4068C5.27277 39.4155 5.28019 39.4229 5.28672 39.4316C5.341 39.5044 5.40214 39.5718 5.46928 39.6327C5.48058 39.6429 5.49135 39.6537 5.50282 39.6636C5.54204 39.6973 5.58307 39.7287 5.62571 39.7579L5.62924 39.76C5.67115 39.7881 5.71453 39.8139 5.75918 39.8373C5.77048 39.8432 5.78213 39.8484 5.79361 39.8541C5.84237 39.8782 5.89248 39.8994 5.94368 39.9177C5.97922 39.9303 6.01536 39.9415 6.05208 39.9513C6.06691 39.9554 6.08174 39.9595 6.09657 39.9629C6.13435 39.9716 6.17284 39.9782 6.21169 39.9839C6.22581 39.9859 6.2394 39.9888 6.25353 39.9904C6.30628 39.9966 6.35932 39.9998 6.41243 40H37.4858C37.7823 40 38.0712 39.9057 38.3117 39.7304C38.5522 39.555 38.7321 39.3077 38.8258 39.0232L43.8559 23.7607C43.9968 23.3311 44.0351 22.8739 43.9676 22.4264C43.9001 21.979 43.7287 21.5541 43.4674 21.1866ZM17.241 12.8571L22.1373 16.5714C22.627 16.9412 23.2213 17.1416 23.8324 17.1429H36.0734V20H13.0801C12.4871 19.9994 11.909 20.1879 11.4278 20.5386C10.9467 20.8892 10.5871 21.3844 10.4001 21.9536L7.82485 29.7682V12.8571H17.241Z"
            />
          </svg>

          <svg
            v-if="node.children.length === 0"
            class="flex-shrink-0 w-4 h-4"
            viewBox="0 0 50 50"
            fill="#FBBF24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M41 14.1818H25.1214L20 8.90545C19.7221 8.61753 19.3915 8.38926 19.0274 8.23384C18.6633 8.07842 18.2729 7.99895 17.8788 8.00001H8C7.20462 8.00093 6.44208 8.32688 5.87967 8.90633C5.31725 9.48579 5.00089 10.2714 5 11.0909V39.0279C5.00084 39.8159 5.30504 40.5713 5.84584 41.1285C6.38664 41.6857 7.11988 41.9991 7.88469 42H41.1667C41.9179 41.9991 42.638 41.6913 43.1692 41.144C43.7004 40.5968 43.9992 39.8548 44 39.0808V17.2727C43.9991 16.4533 43.6827 15.6676 43.1203 15.0881C42.5579 14.5087 41.7954 14.1827 41 14.1818ZM17.8788 11.0909L20.8786 14.1818H8V11.0909H17.8788ZM41 38.9091H8V17.2727H41V38.9091Z"
            />
          </svg>

          <span class="node-title-style text-xs text-left text-gray-600">{{ node.title }}</span>
        </button>
        <!-- bookmark node -->
        <button
          v-if="!node.children"
          class="flex-grow p-0.5 flex items-start hover:bg-gray-200 space-x-0.5 rounded-sm"
        >
          <div class="flex-shrink-0 p-0.5">
            <div
              class="bookmark-favicon w-3 h-3 bg-cover bg-center bg-no-repeat"
              :style="{
                backgroundImage:
                  'url(' + `https://www.youtube.com/s/desktop/4eebcda0/img/favicon_32x32.png` + ')',
              }"
            />
          </div>

          <span class="node-title-style text-xs text-left text-gray-600">{{ node.title }}</span>
        </button>
        <!-- more button -->
        <div class="flex items-center space-x-0.5">
          <button
            v-if="!node.children"
            title="copy bookmark url"
            class="p-0.5 text-gray-300 hover:text-gray-600 hover:bg-gray-200 rounded-sm"
          >
            <svg
              class="w-4 h-4"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M43.3333 5H16.6668C16.2248 5 15.8009 5.17559 15.4883 5.48815C15.1757 5.80071 15.0002 6.22463 15.0002 6.66666V15.0002H6.66666C6.22463 15.0002 5.80071 15.1757 5.48815 15.4883C5.17559 15.8009 5 16.2248 5 16.6668V43.3333C5 43.7754 5.17559 44.1993 5.48815 44.5118C5.80071 44.8244 6.22463 45 6.66666 45H33.3332C33.7752 45 34.1991 44.8244 34.5117 44.5118C34.8242 44.1993 34.9998 43.7754 34.9998 43.3333V35.0001H43.3333C43.7754 35.0001 44.1993 34.8245 44.5118 34.5119C44.8244 34.1993 45 33.7754 45 33.3334V6.66687C45 6.22484 44.8244 5.80092 44.5118 5.48836C44.1993 5.1758 43.7754 5.00021 43.3333 5.00021V5ZM31.6665 41.6667H8.33332V18.3335H31.6665V41.6667ZM41.6667 31.6667H34.9998V16.6668C34.9998 16.2248 34.8242 15.8009 34.5117 15.4883C34.1991 15.1757 33.7752 15.0002 33.3332 15.0002H18.3335V8.33352H41.6667V31.6667Z"
              />
            </svg>
          </button>
          <button
            title="show more setting menu"
            class="p-0.5 text-gray-300 hover:text-gray-600 hover:bg-gray-200 rounded-sm"
            @click="showPopupMenuHandler(node, $event)"
          >
            <svg
              class="w-4 h-4"
              viewBox="0 0 50 50"
              fill="currentColor"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M27.6875 37.3438C27.6875 37.8073 27.55 38.2604 27.2925 38.6459C27.035 39.0313 26.6689 39.3317 26.2407 39.5091C25.8124 39.6865 25.3412 39.7329 24.8865 39.6425C24.4319 39.552 24.0142 39.3288 23.6865 39.001C23.3587 38.6733 23.1355 38.2556 23.045 37.801C22.9546 37.3463 23.001 36.8751 23.1784 36.4468C23.3558 36.0186 23.6562 35.6525 24.0416 35.395C24.4271 35.1375 24.8802 35 25.3438 35C25.9651 35.0007 26.5609 35.2479 27.0002 35.6873C27.4396 36.1266 27.6868 36.7224 27.6875 37.3438ZM25.3438 14.6875C25.8073 14.6875 26.2604 14.55 26.6459 14.2925C27.0313 14.035 27.3317 13.6689 27.5091 13.2407C27.6865 12.8124 27.7329 12.3412 27.6425 11.8865C27.552 11.4319 27.3288 11.0142 27.001 10.6865C26.6733 10.3587 26.2556 10.1355 25.801 10.045C25.3464 9.9546 24.8751 10.001 24.4468 10.1784C24.0186 10.3558 23.6525 10.6562 23.395 11.0416C23.1375 11.4271 23 11.8802 23 12.3438C23.0007 12.9651 23.2479 13.5609 23.6873 14.0002C24.1267 14.4396 24.7224 14.6868 25.3438 14.6875ZM25.3438 22.5C24.8802 22.5 24.4271 22.6375 24.0416 22.895C23.6562 23.1525 23.3558 23.5186 23.1784 23.9468C23.001 24.3751 22.9546 24.8464 23.045 25.301C23.1355 25.7556 23.3587 26.1733 23.6865 26.501C24.0142 26.8288 24.4319 27.052 24.8865 27.1425C25.3412 27.2329 25.8124 27.1865 26.2407 27.0091C26.6689 26.8317 27.035 26.5313 27.2925 26.1459C27.55 25.7604 27.6875 25.3073 27.6875 24.8438C27.6868 24.2224 27.4396 23.6267 27.0002 23.1873C26.5609 22.7479 25.9651 22.5007 25.3438 22.5Z"
              />
            </svg>
          </button>
        </div>
      </div>

      <!-- unfold folder -->
      <div
        v-if="unfoldFolders.has(node.id)"
        class="unfold-folders-container px-2 py-0.5 space-y-1"
      >
        <div
          v-for="childNode of node.children"
          :key="childNode.id"
          class="p-1 flex items-start bg-gray-50 rounded"
        >
          <button
            v-if="childNode.children"
            class="flex-grow p-0.5 flex items-start hover:bg-gray-200 space-x-0.5 rounded-sm"
            @click="$emit('open-folder', childNode.id)"
          >
            <svg
              v-if="childNode.children.length > 0"
              class="flex-shrink-0 w-4 h-4"
              viewBox="0 0 50 50"
              fill="#FBBF24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M41 14H25.1212L20 8.87901C19.7222 8.5995 19.3916 8.37788 19.0276 8.227C18.6635 8.07612 18.2731 7.99896 17.879 8.00001H8C7.20459 8.0008 6.44199 8.31713 5.87956 8.87957C5.31712 9.442 5.00079 10.2046 5 11V38.1157C5.00104 38.8806 5.30544 39.6138 5.84641 40.1545C6.38738 40.6952 7.12075 40.9993 7.88562 41H41.1669C41.918 40.999 42.638 40.7002 43.1691 40.1691C43.7002 39.638 43.999 38.918 44 38.1669V17.0002C43.9992 16.2048 43.6829 15.4422 43.1204 14.8798C42.558 14.3173 41.7954 14.001 41 14.0002V14ZM8 11H17.879L20.879 14H8V11Z"
              />
            </svg>

            <svg
              v-if="childNode.children.length === 0"
              class="flex-shrink-0 w-4 h-4"
              viewBox="0 0 50 50"
              fill="#FBBF24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M41 14.1818H25.1214L20 8.90545C19.7221 8.61753 19.3915 8.38926 19.0274 8.23384C18.6633 8.07842 18.2729 7.99895 17.8788 8.00001H8C7.20462 8.00093 6.44208 8.32688 5.87967 8.90633C5.31725 9.48579 5.00089 10.2714 5 11.0909V39.0279C5.00084 39.8159 5.30504 40.5713 5.84584 41.1285C6.38664 41.6857 7.11988 41.9991 7.88469 42H41.1667C41.9179 41.9991 42.638 41.6913 43.1692 41.144C43.7004 40.5968 43.9992 39.8548 44 39.0808V17.2727C43.9991 16.4533 43.6827 15.6676 43.1203 15.0881C42.5579 14.5087 41.7954 14.1827 41 14.1818ZM17.8788 11.0909L20.8786 14.1818H8V11.0909H17.8788ZM41 38.9091H8V17.2727H41V38.9091Z"
              />
            </svg>

            <span
              class="node-title-style text-xs text-left text-gray-600"
            >{{ childNode.title }}</span>
          </button>
          <button
            v-if="!childNode.children"
            class="flex-grow p-0.5 flex items-start hover:bg-gray-200 space-x-0.5 rounded-sm"
          >
            <div class="flex-shrink-0 p-0.5">
              <div
                class="bookmark-favicon w-3 h-3 bg-cover bg-center bg-no-repeat"
                :style="{
                  backgroundImage:
                    'url(' + `https://www.youtube.com/s/desktop/4eebcda0/img/favicon_32x32.png` + ')',
                }"
              />
            </div>
            <span class="node-title-style text-xs text-left text-gray-600">{{ childNode.title }}</span>
          </button>
          <div class="flex items-center space-x-0.5">
            <button
              v-if="!childNode.children"
              title="copy bookmark url"
              class="p-0.5 text-gray-300 hover:text-gray-600 hover:bg-gray-200 rounded-sm"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 50 50"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M43.3333 5H16.6668C16.2248 5 15.8009 5.17559 15.4883 5.48815C15.1757 5.80071 15.0002 6.22463 15.0002 6.66666V15.0002H6.66666C6.22463 15.0002 5.80071 15.1757 5.48815 15.4883C5.17559 15.8009 5 16.2248 5 16.6668V43.3333C5 43.7754 5.17559 44.1993 5.48815 44.5118C5.80071 44.8244 6.22463 45 6.66666 45H33.3332C33.7752 45 34.1991 44.8244 34.5117 44.5118C34.8242 44.1993 34.9998 43.7754 34.9998 43.3333V35.0001H43.3333C43.7754 35.0001 44.1993 34.8245 44.5118 34.5119C44.8244 34.1993 45 33.7754 45 33.3334V6.66687C45 6.22484 44.8244 5.80092 44.5118 5.48836C44.1993 5.1758 43.7754 5.00021 43.3333 5.00021V5ZM31.6665 41.6667H8.33332V18.3335H31.6665V41.6667ZM41.6667 31.6667H34.9998V16.6668C34.9998 16.2248 34.8242 15.8009 34.5117 15.4883C34.1991 15.1757 33.7752 15.0002 33.3332 15.0002H18.3335V8.33352H41.6667V31.6667Z"
                />
              </svg>
            </button>
            <button
              title="show more setting menu"
              class="p-0.5 text-gray-300 hover:text-gray-600 hover:bg-gray-200 rounded-sm"
              @click="showPopupMenuHandler(childNode, $event)"
            >
              <svg
                class="w-4 h-4"
                viewBox="0 0 50 50"
                fill="currentColor"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M27.6875 37.3438C27.6875 37.8073 27.55 38.2604 27.2925 38.6459C27.035 39.0313 26.6689 39.3317 26.2407 39.5091C25.8124 39.6865 25.3412 39.7329 24.8865 39.6425C24.4319 39.552 24.0142 39.3288 23.6865 39.001C23.3587 38.6733 23.1355 38.2556 23.045 37.801C22.9546 37.3463 23.001 36.8751 23.1784 36.4468C23.3558 36.0186 23.6562 35.6525 24.0416 35.395C24.4271 35.1375 24.8802 35 25.3438 35C25.9651 35.0007 26.5609 35.2479 27.0002 35.6873C27.4396 36.1266 27.6868 36.7224 27.6875 37.3438ZM25.3438 14.6875C25.8073 14.6875 26.2604 14.55 26.6459 14.2925C27.0313 14.035 27.3317 13.6689 27.5091 13.2407C27.6865 12.8124 27.7329 12.3412 27.6425 11.8865C27.552 11.4319 27.3288 11.0142 27.001 10.6865C26.6733 10.3587 26.2556 10.1355 25.801 10.045C25.3464 9.9546 24.8751 10.001 24.4468 10.1784C24.0186 10.3558 23.6525 10.6562 23.395 11.0416C23.1375 11.4271 23 11.8802 23 12.3438C23.0007 12.9651 23.2479 13.5609 23.6873 14.0002C24.1267 14.4396 24.7224 14.6868 25.3438 14.6875ZM25.3438 22.5C24.8802 22.5 24.4271 22.6375 24.0416 22.895C23.6562 23.1525 23.3558 23.5186 23.1784 23.9468C23.001 24.3751 22.9546 24.8464 23.045 25.301C23.1355 25.7556 23.3587 26.1733 23.6865 26.501C24.0142 26.8288 24.4319 27.052 24.8865 27.1425C25.3412 27.2329 25.8124 27.1865 26.2407 27.0091C26.6689 26.8317 27.035 26.5313 27.2925 26.1459C27.55 25.7604 27.6875 25.3073 27.6875 24.8438C27.6868 24.2224 27.4396 23.6267 27.0002 23.1873C26.5609 22.7479 25.9651 22.5007 25.3438 22.5Z"
                />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <PopupMenu
      v-if="showPopupMenu"
      v-model:show="showPopupMenu"
      :left="left"
      :top="top"
      :menu-width="160"
      :menu-height="120"
    >
      <!-- star item -->
      <button
        title="toggle item star state"
        class="btn text-gray-600 hover:text-yellow-600 hover:bg-yellow-50 "
        @click="toggleStarState"
      >
        <div
          class="menu-icon-style border-yellow-400"
          :class="{ 'bg-yellow-400 text-white': starState, 'text-yellow-400': !starState }"
        >
          <svg
            class="w-3 h-3"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M35.5819 44C35.0316 43.9995 34.4928 43.8445 34.0286 43.5533L25.0232 37.9313C25.0165 37.9264 25.0084 37.9237 25 37.9237C24.9916 37.9237 24.9835 37.9264 24.9768 37.9313L16.6078 43.156C16.0683 43.4954 15.4374 43.6664 14.7976 43.6466C14.1579 43.6267 13.5391 43.4171 13.0223 43.045C12.4873 42.6632 12.0817 42.1311 11.8587 41.5185C11.6357 40.9058 11.6056 40.241 11.7724 39.6112L14.1856 30.2582C14.1921 30.2349 14.1922 30.2103 14.1858 30.187C14.1795 30.1636 14.1669 30.1423 14.1494 30.1254L6.07358 23.5023C5.61332 23.1256 5.2791 22.6208 5.1146 22.0539C4.95009 21.487 4.96296 20.8844 5.15151 20.3248C5.32919 19.7728 5.67173 19.2865 6.13437 18.9293C6.59701 18.5721 7.15823 18.3608 7.7447 18.3228L18.2912 17.6484C18.3052 17.6451 18.318 17.6381 18.3284 17.6282C18.3387 17.6184 18.3462 17.606 18.3501 17.5923L22.2838 7.83224C22.4963 7.29262 22.8694 6.82891 23.3542 6.50194C23.8389 6.17496 24.4126 6 25.0001 6C25.5875 6 26.1613 6.17496 26.646 6.50194C27.1307 6.82891 27.5039 7.29262 27.7164 7.83224L31.65 17.5921C31.6539 17.6058 31.6613 17.6182 31.6716 17.6281C31.6819 17.638 31.6947 17.645 31.7086 17.6484L42.2553 18.3228C42.8417 18.3608 43.4029 18.5721 43.8655 18.9292C44.3282 19.2863 44.6707 19.7726 44.8485 20.3245C45.037 20.8841 45.0499 21.4866 44.8854 22.0535C44.7209 22.6204 44.3867 23.1252 43.9264 23.502L35.851 30.1249C35.8334 30.1418 35.8207 30.1631 35.8144 30.1866C35.808 30.21 35.8081 30.2347 35.8147 30.258L38.4167 40.3433C38.5676 40.9136 38.5402 41.5155 38.3381 42.0702C38.1361 42.625 37.7688 43.1067 37.2842 43.4523C36.7898 43.8074 36.1939 43.9991 35.5821 43.9998L35.5819 44ZM25 35.1121C25.5493 35.1113 26.0876 35.2644 26.552 35.5535L35.5578 41.1755C35.5657 41.1809 35.5745 41.1852 35.5837 41.1883C35.6056 41.1775 35.6244 41.1614 35.6383 41.1415C35.6483 41.1261 35.6544 41.1086 35.656 41.0904C35.6576 41.0722 35.6548 41.0539 35.6478 41.037L33.0458 30.9516C32.9072 30.413 32.9254 29.8469 33.0983 29.3181C33.2711 28.7892 33.5916 28.319 34.0231 27.9613L42.0987 21.3384C42.1204 21.3223 42.1356 21.2992 42.1417 21.2731C42.1478 21.2471 42.1443 21.2197 42.1319 21.1959C42.1117 21.1349 42.0907 21.1335 42.0701 21.1322L31.5236 20.4579C30.9703 20.4189 30.4393 20.2268 29.9919 19.9036C29.5444 19.5804 29.1987 19.1393 28.9945 18.6311L25.0609 8.87134C25.0384 8.81504 25.0239 8.81504 25 8.81504C24.9761 8.81504 24.9616 8.81504 24.9389 8.87134L21.0053 18.6312C20.801 19.1394 20.4553 19.5805 20.0079 19.9036C19.5605 20.2268 19.0295 20.4189 18.4762 20.4579L7.92987 21.1322C7.90933 21.1335 7.88826 21.1349 7.86809 21.1959C7.85568 21.2197 7.85222 21.2471 7.85829 21.2731C7.86437 21.2992 7.8796 21.3223 7.9013 21.3384L15.9771 27.9615C16.4085 28.3192 16.729 28.7894 16.9018 29.3182C17.0746 29.847 17.0928 30.4131 16.9544 30.9516L14.5413 40.3046C14.5143 40.3881 14.515 40.4779 14.5435 40.5609C14.572 40.6439 14.6266 40.7158 14.6995 40.7661C14.7522 40.8097 14.8182 40.8346 14.887 40.8368C14.9557 40.839 15.0232 40.8183 15.0786 40.778L23.448 35.5535C23.9124 35.2644 24.4506 35.1112 25 35.1119V35.1121Z"
            />
          </svg>
        </div>
        <span class="text-xs">{{ starState ? '未设为常用' : '已设为常用' }}</span>
      </button>
      <!-- share item(s) -->
      <button
        title="toggle item share state"
        class="btn text-gray-600 hover:text-green-600 hover:bg-green-50"
        @click="toggleShareState"
      >
        <div
          class="menu-icon-style border-green-400"
          :class="{ 'bg-green-400 text-white': shareState, 'text-green-400': !shareState }"
        >
          <svg
            class="w-3 h-3"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M34.9183 30.7139C33.9734 30.7136 33.0381 30.9046 32.1678 31.2756C31.2974 31.6466 30.5098 32.1901 29.8515 32.8738L21.6901 27.5808C22.331 25.9199 22.331 24.0769 21.6901 22.416L29.8515 17.1232C31.0766 18.3875 32.7235 19.148 34.4728 19.2571C36.2221 19.3662 37.9493 18.8163 39.3196 17.7139C40.6898 16.6114 41.6055 15.0351 41.8892 13.2903C42.1729 11.5455 41.8043 9.75662 40.855 8.27038C39.9056 6.78413 38.4431 5.7064 36.7509 5.24608C35.0586 4.78576 33.2573 4.97564 31.6959 5.77891C30.1346 6.58219 28.9245 7.94165 28.3002 9.59377C27.6759 11.2459 27.6819 13.073 28.317 14.7209L20.1554 20.0139C19.1726 18.9959 17.9111 18.2967 16.5324 18.0057C15.1536 17.7146 13.7201 17.845 12.4151 18.3801C11.1101 18.9153 9.99303 19.8308 9.20656 21.0098C8.42009 22.1887 8 23.5775 8 24.9985C8 26.4196 8.42009 27.8083 9.20656 28.9873C9.99303 30.1662 11.1101 31.0818 12.4151 31.6169C13.7201 32.152 15.1536 32.2824 16.5324 31.9914C17.9111 31.7003 19.1726 31.0011 20.1554 29.9831L28.317 35.2759C27.7706 36.6983 27.6899 38.2598 28.0868 39.7318C28.4837 41.2037 29.3373 42.5089 30.5226 43.4561C31.7079 44.4033 33.1627 44.9428 34.6739 44.9957C36.1852 45.0486 37.6735 44.612 38.921 43.7499C40.1685 42.8877 41.1096 41.6454 41.6066 40.2047C42.1036 38.764 42.1304 37.2006 41.6829 35.7434C41.2355 34.2863 40.3374 33.0119 39.1202 32.1069C37.9029 31.2018 36.4304 30.7137 34.9183 30.7139ZM34.9183 7.85223C35.7587 7.85223 36.5802 8.10363 37.279 8.57465C37.9777 9.04566 38.5224 9.71513 38.844 10.4984C39.1656 11.2817 39.2497 12.1436 39.0858 12.9751C38.9218 13.8066 38.5171 14.5704 37.9229 15.1699C37.3286 15.7693 36.5715 16.1776 35.7472 16.343C34.923 16.5084 34.0686 16.4235 33.2922 16.0991C32.5157 15.7746 31.8521 15.2252 31.3852 14.5203C30.9183 13.8154 30.6691 12.9866 30.6691 12.1388C30.6703 11.0023 31.1184 9.91276 31.915 9.10915C32.7116 8.30554 33.7917 7.85351 34.9183 7.85223ZM15.0888 29.2851C14.2484 29.2851 13.4268 29.0337 12.7281 28.5627C12.0293 28.0916 11.4847 27.4222 11.1631 26.6389C10.8415 25.8556 10.7573 24.9938 10.9213 24.1622C11.0852 23.3307 11.4899 22.5669 12.0842 21.9674C12.6784 21.368 13.4356 20.9597 14.2598 20.7943C15.0841 20.6289 15.9384 20.7138 16.7149 21.0382C17.4913 21.3627 18.1549 21.9121 18.6218 22.617C19.0887 23.3219 19.338 24.1507 19.338 24.9985C19.3367 26.135 18.8886 27.2246 18.092 28.0282C17.2954 28.8318 16.2153 29.2838 15.0888 29.2851ZM34.9183 42.1448C34.0778 42.1448 33.2563 41.8934 32.5575 41.4224C31.8588 40.9514 31.3141 40.2819 30.9925 39.4986C30.6709 38.7153 30.5868 37.8535 30.7507 37.0219C30.9147 36.1904 31.3194 35.4266 31.9136 34.8272C32.5079 34.2277 33.265 33.8194 34.0893 33.654C34.9135 33.4886 35.7679 33.5735 36.5443 33.8979C37.3208 34.2224 37.9844 34.7718 38.4513 35.4767C38.9182 36.1817 39.1674 37.0104 39.1674 37.8582C39.1662 38.9947 38.7181 40.0843 37.9215 40.8879C37.1249 41.6915 36.0448 42.1435 34.9183 42.1448Z"
            />
          </svg>
        </div>
        <span class="text-xs">{{ shareState ? '已开启共享' : '未开启共享' }}</span>
      </button>
      <!-- edit folder name -->
      <button
        v-if="selectItemType === 'folder'"
        title="edit folder name"
        class="btn text-gray-600 hover:text-blue-600 hover:bg-blue-50"
        @click="renameFolderHandler"
      >
        <div class="menu-icon-style text-blue-400 border-blue-400">
          <svg
            class="w-3 h-3"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M43.0724 14.79L34.2112 5.92926C33.9166 5.63465 33.5669 5.40095 33.1819 5.24151C32.797 5.08206 32.3845 5 31.9678 5C31.5512 5 31.1386 5.08206 30.7537 5.24151C30.3688 5.40095 30.019 5.63465 29.7244 5.92926L24.501 11.1525V11.1527L24.5006 11.1529L5.92941 29.7235C5.63386 30.0173 5.39953 30.3669 5.24 30.752C5.08047 31.137 4.9989 31.5499 5.00001 31.9667V40.8274C5.00096 41.6686 5.33552 42.475 5.93032 43.0697C6.52511 43.6645 7.33155 43.9991 8.17271 44H17.6908C17.8991 44 18.1054 43.959 18.2979 43.8793C18.4903 43.7996 18.6652 43.6827 18.8125 43.5354L43.0724 19.2764C43.6664 18.681 44 17.8743 44 17.0332C44 16.1922 43.6664 15.3854 43.0724 14.79ZM17.0338 40.8274H8.17271V31.9667L25.6225 14.5176L34.4837 23.3783L17.0338 40.8274ZM36.727 21.1351L27.866 12.2744L31.9679 8.17246L40.8291 17.0332L36.727 21.1351Z"
            />
          </svg>
        </div>
        <span class="menu-text-style">重命名文件夹</span>
      </button>
      <!-- edit bookmark -->
      <button
        v-if="selectItemType === 'bookmark'"
        title="edit bookmark"
        class="btn text-gray-600 hover:text-blue-600 hover:bg-blue-50"
      >
        <div class="menu-icon-style text-blue-400 border-blue-400">
          <svg
            class="w-3 h-3"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M43.0724 14.79L34.2112 5.92926C33.9166 5.63465 33.5669 5.40095 33.1819 5.24151C32.797 5.08206 32.3845 5 31.9678 5C31.5512 5 31.1386 5.08206 30.7537 5.24151C30.3688 5.40095 30.019 5.63465 29.7244 5.92926L24.501 11.1525V11.1527L24.5006 11.1529L5.92941 29.7235C5.63386 30.0173 5.39953 30.3669 5.24 30.752C5.08047 31.137 4.9989 31.5499 5.00001 31.9667V40.8274C5.00096 41.6686 5.33552 42.475 5.93032 43.0697C6.52511 43.6645 7.33155 43.9991 8.17271 44H17.6908C17.8991 44 18.1054 43.959 18.2979 43.8793C18.4903 43.7996 18.6652 43.6827 18.8125 43.5354L43.0724 19.2764C43.6664 18.681 44 17.8743 44 17.0332C44 16.1922 43.6664 15.3854 43.0724 14.79ZM17.0338 40.8274H8.17271V31.9667L25.6225 14.5176L34.4837 23.3783L17.0338 40.8274ZM36.727 21.1351L27.866 12.2744L31.9679 8.17246L40.8291 17.0332L36.727 21.1351Z"
            />
          </svg>
        </div>
        <span class="text-xs">修改书签</span>
      </button>
      <!-- delete item -->
      <button
        title="delete item"
        class="w-full p-1 flex items-center space-x-1 rounded text-red-400 hover:bg-red-400 hover:text-white"
        @click="deleteItemHandler"
      >
        <div class="menu-icon-style border-red-400">
          <svg
            class="w-3 h-3"
            viewBox="0 0 50 50"
            fill="currentColor"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M41.5 11H34.0007V9.5C33.9994 8.30694 33.5249 7.16312 32.6813 6.3195C31.8376 5.47588 30.6938 5.00134 29.5007 5H20.5007C19.3077 5.00134 18.1639 5.47588 17.3202 6.3195C16.4766 7.16312 16.0021 8.30694 16.0007 9.5V11H8.5C8.10217 11 7.72064 11.158 7.43934 11.4393C7.15804 11.7206 7 12.1022 7 12.5C7 12.8978 7.15804 13.2794 7.43934 13.5607C7.72064 13.842 8.10217 14 8.5 14H10V41C10.0009 41.7954 10.3173 42.5579 10.8797 43.1203C11.4421 43.6827 12.2046 43.9991 13 44H37C37.7954 43.9991 38.5579 43.6827 39.1203 43.1203C39.6827 42.5579 39.9991 41.7954 40 41V14H41.5C41.8978 14 42.2794 13.842 42.5607 13.5607C42.842 13.2794 43 12.8978 43 12.5C43 12.1022 42.842 11.7206 42.5607 11.4393C42.2794 11.158 41.8978 11 41.5 11ZM19.0007 9.5C19.0012 9.10233 19.1594 8.72109 19.4406 8.43989C19.7218 8.15869 20.1031 8.0005 20.5007 8H29.5007C29.8984 8.0005 30.2797 8.15869 30.5609 8.43989C30.8421 8.72109 31.0003 9.10233 31.0007 9.5V11H19.0007V9.5ZM37 41H13V14H37V41ZM22.0007 21.5V33.5C22.0007 33.8978 21.8427 34.2794 21.5614 34.5607C21.2801 34.842 20.8986 35 20.5007 35C20.1029 35 19.7214 34.842 19.4401 34.5607C19.1588 34.2794 19.0007 33.8978 19.0007 33.5V21.5C19.0007 21.1022 19.1588 20.7206 19.4401 20.4393C19.7214 20.158 20.1029 20 20.5007 20C20.8986 20 21.2801 20.158 21.5614 20.4393C21.8427 20.7206 22.0007 21.1022 22.0007 21.5ZM31.0007 21.5V33.5C31.0007 33.8978 30.8427 34.2794 30.5614 34.5607C30.2801 34.842 29.8986 35 29.5007 35C29.1029 35 28.7214 34.842 28.4401 34.5607C28.1588 34.2794 28.0007 33.8978 28.0007 33.5V21.5C28.0007 21.1022 28.1588 20.7206 28.4401 20.4393C28.7214 20.158 29.1029 20 29.5007 20C29.8986 20 30.2801 20.158 30.5614 20.4393C30.8427 20.7206 31.0007 21.1022 31.0007 21.5Z"
            />
          </svg>
        </div>
        <span class="text-xs">{{ selectItemType === 'bookmark' ? '删除书签' : '删除文件夹及其书签' }}</span>
      </button>
    </PopupMenu>
    <InputModal
      v-if="showRenameFolderModal"
      v-model:show="showRenameFolderModal"
      :init-value="'folder_name'"
      :placeholder="'请输入文件夹名称'"
      @result="getRenameResultHandler"
    >
      <template #title>
        <label
          for="input-modal"
          class="block p-4 text-sm text-center font-bold"
        >重命名文件夹</label>
      </template>
    </InputModal>
    <PromptModal
      v-if="showConfirmDeleteModal"
      v-model:show="showConfirmDeleteModal"
      @result="getDeleteResult"
    >
      <template #title>
        <h2 class="p-4 text-sm font-bold">
          是否删除
        </h2>
      </template>
      <template #msg>
        <p class="p-2 text-xs text-center">
          {{ selectItem }}
        </p>
      </template>
    </PromptModal>
  </div>
</template>

<script>
import { ref } from 'vue';
import PopupMenu from '../Modal/PopupMenu.vue';
import InputModal from '../Modal/InputModal.vue';
import PromptModal from '../Modal/PromptModal.vue';

export default {
  components: {
    PopupMenu,
    InputModal,
    PromptModal,
  },
  props: {
    nodes: {
      type: Array,
      default() {
        return [];
      },
    },
  },
  emits: ['open-folder'],
  setup(props) {
    /**
     * bookmark data
     */
    const unfoldFolders = ref(new Set());
    // unfold or fold folder handler
    const toggleFolderState = (node) => {
      if (node.children.length === 0) return;
      if (unfoldFolders.value.has(node.id)) {
        unfoldFolders.value.delete(node.id);
      } else {
        unfoldFolders.value.add(node.id);
      }
    };
    const unfoldAll = () => {
      props.nodes.forEach((node) => {
        if (node.children && node.children.length > 0) {
          unfoldFolders.value.add(node.id);
        }
      });
    };

    const foldAll = () => {
      unfoldFolders.value.clear();
    };
    /**
     * modal
     */

    // popup menu
    // show state and location
    const showPopupMenu = ref(false);
    const left = ref(0);
    const top = ref(0);
    const selectItem = ref('');
    const selectItemType = ref('folder'); // folder, bookmark

    const showPopupMenuHandler = (value, event) => {
      const target = event.currentTarget;
      if (!target) return;
      selectItem.value = value;
      selectItemType.value = 'folder';
      // left.value = target.offsetLeft;
      // top.value = target.offsetTop;
      left.value = event.clientX;
      top.value = event.clientY;
      showPopupMenu.value = true;
    };

    // popup menu items
    // star
    const starState = ref('false');
    const toggleStarState = () => {
      starState.value = !starState.value;
    };

    // share
    const shareState = ref('false');
    const toggleShareState = () => {
      shareState.value = !shareState.value;
    };

    // rename folder name modal
    const showRenameFolderModal = ref(false);
    const renameFolderHandler = () => {
      showRenameFolderModal.value = true;
      showPopupMenu.value = false;
    };
    const getRenameResultHandler = (obj) => {
      // console.log(obj);
    };

    // delete prompt modal
    const showConfirmDeleteModal = ref(false);
    const deleteItemHandler = () => {
      showConfirmDeleteModal.value = true;
      showPopupMenu.value = false;
    };
    const getDeleteResult = (value) => {
      // console.log(value);
    };

    return {
      unfoldFolders,
      toggleFolderState,
      unfoldAll,
      foldAll,
      showPopupMenu,
      left,
      top,
      showPopupMenuHandler,
      selectItemType,
      selectItem,
      starState,
      toggleStarState,
      shareState,
      toggleShareState,
      showRenameFolderModal,
      renameFolderHandler,
      getRenameResultHandler,
      showConfirmDeleteModal,
      deleteItemHandler,
      getDeleteResult,
    };
  },
};
</script>

<style lang="scss" scoped>
.grid-item {
  height: fit-content;
}

.unfold-folders-container {
  max-height: 10rem;
  overflow-y: overlay;
  &::-webkit-scrollbar {
    width: 4px;
    height: 4px;
  }
  &::-webkit-scrollbar-thumb {
    border-radius: 2px;
    background-color: #9ca3af;
    // border: 3px solid transparent;
    // background-clip: padding-box;
  }
  &::-webkit-scrollbar-thumb:hover {
    background-color: #4b5563;
  }
}

.btn {
  @apply w-full p-1 flex items-center space-x-1 rounded;
}

.menu-icon-style {
  @apply p-0.5 border rounded-sm;
}

// .menu-text-style {
//   @apply text-xs text-gray-600;
// }

.node-title-style {
  word-break: break-all;
}
</style>
